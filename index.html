<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panitia Qurban MNF - Sistem Manajemen</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            box-sizing: border-box;
        }
        .islamic-pattern {
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23065f46' fill-opacity='0.05'%3E%3Cpath d='M30 30c0-11.046-8.954-20-20-20s-20 8.954-20 20 8.954 20 20 20 20-8.954 20-20zm0 0c0 11.046 8.954 20 20 20s20-8.954 20-20-8.954-20-20-20-20 8.954-20 20z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal {
            backdrop-filter: blur(4px);
        }

         /* Responsif untuk Tablet (lebar 641px–1024px) */
@media (min-width: 641px) and (max-width: 1024px) { 
    nav.flex.space-x-8 {
    flex-wrap: wrap;
    gap: 0.25rem;
    justify-content: center;
  }

  nav.flex.space-x-8 button {
    flex: 1 1 45%;
    text-align: center;
    font-size: 0.9rem;
    padding: 0.5rem;
  }

  /* Ukuran teks sedang */
  .text-4xl { font-size: 2rem !important; }
  .text-2xl { font-size: 1.5rem !important; }
  .text-lg  { font-size: 1.125rem !important; }

  /* Atur ulang layout dashboard agar dua kolom */
  .grid-cols-1.md\:grid-cols-2 {
    grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
  }

  /* Atur lebar maksimum kontainer */
  .max-w-7xl {
    max-width: 90% !important;
  }

  /* Tabel lebih mudah dibaca di tablet */
  table th, table td {
    padding: 0.75rem !important;
    font-size: 0.9rem !important;
  }

  /* Galeri tampil 3 kolom di tablet */
  #galeriGrid {
    grid-template-columns: repeat(3, minmax(0, 1fr)) !important;
  }
}

/* Responsif untuk Layar Besar (PC di atas 1024px) */
@media (min-width: 1025px) {

  /* Maksimalkan ruang */
  body {
    font-size: 1rem;
  }

  /* Tabel tampak lebih lega */
  table th, table td {
    padding: 1rem !important;
  }

  /* Galeri tampil 6 kolom di PC */
  #galeriGrid {
    grid-template-columns: repeat(6, minmax(0, 1fr)) !important;
  }

  /* Header lebih besar dan elegan */
  .text-4xl { font-size: 2.5rem !important; }
  .text-2xl { font-size: 1.75rem !important; }

  /* Atur jarak antar elemen */
  #tabContent {
    padding: 2rem !important;
  }
}

 #laporanPeriode {
    visibility: hidden;
    height: 0;
    margin: 0;
    padding: 0;
  }

    </style>
</head>
<body class="bg-gradient-to-br from-emerald-600 to-white islamic-pattern min-h-screen">
    <!-- Navigation -->
    <nav class="bg-emerald-800 shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <div class="flex items-center">
                         <img src="https://i.ibb.co.com/W4rmSh0f/white-mnf2.png" alt="MNF Icon" width="30" height="30" class="mr-2">
                        <span class="text-lg font-semibold text-white">PHBI MNF</span>
                    </div>
                </div>

                <!-- Tombol Refresh (Tengah Atas) -->
                <div class="mt-2 flex justify-center sm:absolute sm:top-4 sm:left-1/2 sm:-translate-x-1/2 sm:transform">
                    <button id="refreshBtn" class="bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1 rounded-lg shadow-lg transition-colors duration-200 flex items-center">
                        <i class="fas fa-sync-alt mr-2"></i>
                         <!-- Teks “Refresh Data” hanya tampil di tablet/PC -->
  <span class="hidden sm:inline font-semibold text-sm">Refresh Data</span>
                    </button>
                </div>

                <div class="flex items-center space-x-4">
                    <div id="userInfo" class="hidden text-white">
                        <span id="userEmail"></span>
                        <button id="logoutBtn" class="ml-4 bg-red-600 hover:bg-red-700 px-3 py-1 rounded text-sm">
                            <i class="fas fa-sign-out-alt mr-1"></i>Logout
                        </button>
                    </div>
                    <button id="loginBtn" class="bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1 rounded">
                        <i class="fas fa-sign-in-alt mr-1"></i>Login Admin
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Header -->
        <div class="relative mb-8" 
             style="background-image: url(''); 
                    background-size: cover; 
                    background-position: center;">
            
          <!-- LOGO RESPONSIF -->
    <div class="flex justify-center sm:justify-start sm:absolute sm:left-2 sm:top-1 mt-2 sm:mt-0">
      <img src="https://i.ibb.co.com/W4rmSh0f/white-mnf2.png"
            alt="Logo MNF"
            class="w-12 h-12 sm:w-16 sm:h-16 md:w-20 md:h-20 rounded-full object-cover" />
    </div>


            <!-- Content Tengah -->
            <div class="text-center">
                <h2 class="text-4xl font-bold text-emerald-800 mb-2">PANITIA QURBAN</h2>
                <h2 class="text-4xl font-bold text-gray-700">MUSHOLLA NURUL FALAH</h2>
                <p class="text-gray-600 font-medium">Jl. Pahlawan RT.010/04 Sukabumi Selatan Kebon Jeruk Jakarta Barat, 11560</p>
            </div>
        </div>

        <!-- Year Selection -->
        <div class="bg-gradient-to-br rounded-lg shadow-md p-4 mb-6">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold text-gray-800">Dashboard Tahun</h3>
                <select id="yearSelector" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-emerald-500">
                    <option value="2024">1445H / 2024</option>
                    <option value="2023">1444H / 2023</option>
                    <option value="2022">1443H / 2022</option>
                </select>
            </div>
        </div>

        <!-- Main Dashboard Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-gradient-to-r rounded-lg shadow-md p-6 border-l-4 border-emerald-500">
                <div class="flex items-center">
                    <div class="p-3 bg-emerald-100 rounded-full">
                        <i class="fas fa-users text-emerald-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm text-gray-600">Total Panitia</p>
                        <p id="totalPanitia" class="text-2xl font-bold text-gray-800">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-gradient-to-r rounded-lg shadow-md p-6 border-l-4 border-blue-500">
                <div class="flex items-center">
                    <div class="p-3 bg-blue-100 rounded-full">
                        <i class="fas fa-cow text-blue-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm text-gray-600">Total Hewan</p>
                        <p id="totalHewan" class="text-2xl font-bold text-gray-800">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-gradient-to-br rounded-lg shadow-md p-6 border-l-4 border-red-500">
                <div class="flex items-center">
                    <div class="p-3 bg-red-100 rounded-full">
                        <i class="fas fa-users-cog text-red-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm text-gray-600">Total Pequrban</p>
                        <p id="totalPequrban" class="text-2xl font-bold text-gray-800">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-gradient-to-br rounded-lg shadow-md p-6 border-l-4 border-purple-500">
                <div class="flex items-center">
                    <div class="p-3 bg-purple-100 rounded-full">
                        <i class="fas fa-hand-holding-heart text-purple-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm text-gray-600">Total Mustahik</p>
                        <p id="totalMustahik" class="text-2xl font-bold text-gray-800">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Statistics -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
            <!-- Hewan Statistics -->
            <div class="bg-blue-100 rounded-lg shadow-md p-6">
                <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-chart-pie text-blue-600 mr-2"></i>
                    Statistik Hewan
                </h4>
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600 flex items-center">
                            <i class="fas fa-cow text-blue-500 mr-2"></i>Sapi
                        </span>
                        <span id="totalSapi" class="font-semibold text-gray-800">0 ekor</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600 flex items-center">
                            <i class="fas fa-sheep text-green-500 mr-2"></i>Kambing
                        </span>
                        <span id="totalKambing" class="font-semibold text-gray-800">0 ekor</span>
                    </div>
                </div>
            </div>

            <!-- Mustahik per RT -->
            <div class="bg-emerald-100 rounded-lg shadow-md p-6">
                <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-map-marker-alt text-purple-600 mr-2"></i>
                    Mustahik per RT
                </h4>
                <div id="mustahikPerRT" class="space-y-2 max-h-40 overflow-y-auto">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>

            <!-- Guru & Sepuh -->
            <div class="bg-blue-100 rounded-lg shadow-md p-6">
                <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-chalkboard-teacher text-indigo-600 mr-2"></i>
                    Guru & Sepuh
                </h4>
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Guru</span>
                        <span id="totalGuru" class="font-semibold text-gray-800">0 orang</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Sepuh</span>
                        <span id="totalSepuh" class="font-semibold text-gray-800">0 orang</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Tokoh Masyarakat</span>
                        <span id="totalTokoh" class="font-semibold text-gray-800">0 orang</span>
                    </div>
                    <div class="border-t pt-2">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-700 font-medium">Total</span>
                            <span id="totalGuruSepuh" class="font-bold text-indigo-600">0 orang</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Additional Statistics -->
        <div class="grid grid-cols-1 md:grid-cols-1 gap-6 mb-8">
            <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg shadow-md p-6 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-blue-100 text-sm">Dokumentasi</p>
                        <p id="totalFoto" class="text-2xl font-bold">0 foto</p>
                    </div>
                    <i class="fas fa-camera text-blue-200 text-3xl"></i>
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="bg-emerald-100 rounded-lg shadow-md mb-6">
            <div class="border-b border-gray-200">
                <nav class="flex flex-wrap justify-center gap-2 px-2 sm:space-x-8 sm:px-6">
                    <button class="tab-btn active py-4 px-2 border-b-2 border-emerald-500 text-emerald-600 font-medium" data-tab="panitia">
                        <i class="fas fa-users mr-2"></i>Panitia
                    </button>
                    <button class="tab-btn py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="hewan">
                        <i class="fas fa-cow mr-2"></i>Hewan Qurban
                    </button>
                    <button class="tab-btn py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="mustahik">
                        <i class="fas fa-hand-holding-heart mr-2"></i>Mustahik
                    </button>
                    <button class="tab-btn py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="guru">
                        <i class="fas fa-chalkboard-teacher mr-2"></i>Guru & Sepuh
                    </button>
                    <button class="tab-btn py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="galeri">
                        <i class="fas fa-images mr-2"></i>Galeri
                    </button>
                    <button class="tab-btn py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="laporan">
                        <i class="fas fa-chart-bar mr-2"></i>Laporan
                    </button>
                    
                </nav>
            </div>
        </div>

        <!-- Tab Content -->
        <div id="tabContent" class="bg-white rounded-lg shadow-md p-6">
            <!-- Panitia Tab -->
            <div id="panitia-tab" class="tab-content">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold text-gray-800">Data Panitia</h3>
                    <button id="addPanitiaBtn" class="admin-only hidden bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-plus mr-2"></i>Tambah Panitia
                    </button>
                </div>
                
                <!-- Filter and Search Controls -->
                <div class="bg-gray-50 p-4 rounded-lg mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Filter Tahun</label>
                            <select id="filterPanitiaTahun" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-emerald-500">
                                <option value="2024">1445H / 2024</option>
                                <option value="2023">1444H / 2023</option>
                                <option value="2022">1443H / 2022</option>
                                <option value="2021">1442H / 2021</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Cari Nama</label>
                            <input type="text" id="searchPanitia" placeholder="Ketik nama panitia..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-emerald-500">
                        </div>
                        <div class="flex items-end">
                            <button id="resetFilterPanitia" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg">
                                <i class="fas fa-refresh mr-2"></i>Reset
                            </button>
                        </div>
                    </div>
                </div>
                <!-- Wadah tabel dengan scroll -->
<div class="overflow-x-auto overflow-y-auto max-h-[70vh] rounded-lg shadow-md border border-green-200">
  <table class="min-w-full text-sm text-gray-800 bg-white border border-gray-100 border-collapse">
    <thead class="bg-emerald-600 text-white sticky top-0">
      <tr>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider border-b border-gray-200">No</th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider border-b border-gray-200">Nama</th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider border-b border-gray-200">Jabatan</th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider border-b border-gray-200">No. HP</th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider border-b border-gray-200">Tahun</th>
                                <th class="admin-only ${currentUser ? '' : 'hidden'} px-6 py-4 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider border-b border-gray-200">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="panitiaTable" class="bg-white">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Hewan Qurban Tab -->
            <div id="hewan-tab" class="tab-content hidden">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold text-gray-800">Data Hewan Qurban</h3>
                    <button id="addHewanBtn" class="admin-only hidden bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-plus mr-2"></i>Tambah Hewan
                    </button>
                </div>
                
                <!-- Filter and Search Controls -->
                <div class="bg-gray-50 p-4 rounded-lg mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Filter Tahun</label>
                            <select id="filterHewanTahun" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                                <option value="2024">1445H / 2024</option>
                                <option value="2023">1444H / 2023</option>
                                <option value="2022">1443H / 2022</option>
                                <option value="2021">1442H / 2021</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Filter Jenis</label>
                            <select id="filterHewanJenis" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                                <option value="">Semua Jenis</option>
                                <option value="sapi">Sapi</option>
                                <option value="kambing">Kambing</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Cari Pemilik</label>
                            <input type="text" id="searchHewan" placeholder="Ketik nama pemilik..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                        </div>
                        <div class="flex items-end">
                            <button id="resetFilterHewan" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg">
                                <i class="fas fa-refresh mr-2"></i>Reset
                            </button>
                        </div>
                    </div>
                </div>
                <!-- Wadah tabel dengan scroll -->
<div class="overflow-x-auto overflow-y-auto max-h-[70vh] rounded-lg shadow-md border border-gray-300">
  <table class="min-w-full text-sm text-gray-800 bg-white border border-gray-300 border-collapse">
    <thead class="bg-emerald-600 text-white sticky top-0">
      <tr>                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider border-b border-r border-gray-200">No</th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider border-b border-r border-gray-200">Jenis</th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider border-b border-r border-gray-200">Nama Sapi</th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider border-b border-r border-gray-200">Pemilik</th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider border-b border-r border-gray-200">Tahun</th>
                                <th class="admin-only ${currentUser ? '' : 'hidden'} px-6 py-4 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider border-b border-gray-200">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="hewanTable" class="bg-white">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Mustahik Tab -->
            <div id="mustahik-tab" class="tab-content hidden">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold text-gray-800">Data Mustahik</h3>
                    <button id="addMustahikBtn" class="admin-only hidden bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-plus mr-2"></i>Tambah Mustahik
                    </button>
                </div>
                
                <!-- Filter and Search Controls -->
                <div class="bg-gray-50 p-4 rounded-lg mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Filter Tahun</label>
                            <select id="filterMustahikTahun" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-purple-500">
                                <option value="2024">1445H / 2024</option>
                                <option value="2023">1444H / 2023</option>
                                <option value="2022">1443H / 2022</option>
                                <option value="2021">1442H / 2021</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Filter RT</label>
                            <select id="filterMustahikRT" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-purple-500">
                                <option value="">Semua RT</option>
                                <option value="RT 10/04">RT 10/04</option>
                                <option value="RT 03/04">RT 03/04</option>
                                <option value="RT 04/04">RT 04/04</option>
                                <option value="RT 02/03">RT 02/03</option>
                                <option value="RT 03/03">RT 03/03</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Cari Nama</label>
                            <input type="text" id="searchMustahik" placeholder="Ketik nama mustahik..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-purple-500">
                        </div>
                        <div class="flex items-end">
                            <button id="resetFilterMustahik" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg">
                                <i class="fas fa-refresh mr-2"></i>Reset
                            </button>
                        </div>
                    </div>
                </div>
                <!-- Wadah tabel dengan scroll -->
<div class="overflow-x-auto overflow-y-auto max-h-[70vh] rounded-lg shadow-md border border-gray-300">
  <table class="min-w-full text-sm text-gray-800 bg-white border border-gray-300 border-collapse">
    <thead class="bg-emerald-600 text-white sticky top-0">
      <tr>
                                <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider border border-gray-300 bg-purple-100">No</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider border border-gray-300 bg-purple-100">Nama Mustahik</th>
                                <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider border border-gray-300 bg-purple-100">RT</th>
                                <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider border border-gray-300 bg-purple-100">Tahun</th>
                                <th class="admin-only ${currentUser ? '' : 'hidden'} px-6 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider border border-gray-300 bg-purple-100">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="mustahikTable" class="bg-white">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Guru & Sepuh Tab -->
            <div id="guru-tab" class="tab-content hidden">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold text-gray-800">Data Guru & Sepuh</h3>
                    <button id="addGuruBtn" class="admin-only hidden bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-plus mr-2"></i>Tambah Data
                    </button>
                </div>
                
                <!-- Filter and Search Controls -->
                <div class="bg-gray-50 p-4 rounded-lg mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Filter Tahun</label>
                            <select id="filterGuruTahun" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-500">
                                <option value="2024">1445H / 2024</option>
                                <option value="2023">1444H / 2023</option>
                                <option value="2022">1443H / 2022</option>
                                <option value="2021">1442H / 2021</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Filter Kategori</label>
                            <select id="filterGuruKategori" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-500">
                                <option value="">Semua Kategori</option>
                                <option value="guru">Guru</option>
                                <option value="sepuh">Sepuh</option>
                                <option value="tokoh">Tokoh Masyarakat</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Cari Nama</label>
                            <input type="text" id="searchGuru" placeholder="Ketik nama..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-500">
                        </div>
                        <div class="flex items-end">
                            <button id="resetFilterGuru" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg">
                                <i class="fas fa-refresh mr-2"></i>Reset
                            </button>
                        </div>
                    </div>
                </div>
                <!-- Wadah tabel dengan scroll -->
<div class="overflow-x-auto overflow-y-auto max-h-[70vh] rounded-lg shadow-md border border-gray-300">
  <table class="min-w-full text-sm text-gray-800 bg-white border border-gray-300 border-collapse">
    <thead class="bg-emerald-600 text-white sticky top-0">
      <tr>
                                <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider border border-gray-300 bg-indigo-100">No</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider border border-gray-300 bg-indigo-100">Nama</th>
                                <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider border border-gray-300 bg-indigo-100">Kategori</th>
                                <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider border border-gray-300 bg-indigo-100">Tahun</th>
                                <th class="admin-only ${currentUser ? '' : 'hidden'} px-6 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider border border-gray-300 bg-indigo-100">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="guruTable" class="bg-white">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Galeri Tab -->
            <div id="galeri-tab" class="tab-content hidden">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold text-gray-800">Galeri Dokumentasi Qurban</h3>
                    <button id="addFotoBtn" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-plus mr-2"></i>Upload Foto
                    </button>
                </div>
                
                <!-- Filter Controls -->
                <div class="bg-gray-50 p-4 rounded-lg mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Filter Tahun</label>
                            <select id="filterGaleriTahun" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-orange-500">
                                
                                <option value="2024">1445H / 2024</option>
                                <option value="2023">1444H / 2023</option>
                                <option value="2022">1443H / 2022</option>
                                <option value="2021">1442H / 2021</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Cari Foto</label>
                            <input type="text" id="searchGaleri" placeholder="Ketik keterangan foto..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-orange-500">
                        </div>
                        <div class="flex items-end">
                            <button id="resetFilterGaleri" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg">
                                <i class="fas fa-refresh mr-2"></i>Reset
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Photo Count Info -->
                <div class="mb-4">
                    <p class="text-sm text-gray-600">
                        <i class="fas fa-images mr-1"></i>
                        Total: <span id="totalFotoGaleri" class="font-semibold">0</span> foto
                    </p>
                </div>
                
                <!-- Photo Grid -->
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8 gap-3" id="galeriGrid">
                </div>
                
                <!-- No Photos Message -->
                <div id="noPhotosMessage" class="hidden text-center py-12">
                    <i class="fas fa-camera text-gray-300 text-6xl mb-4"></i>
                    <p class="text-gray-500 text-lg mb-2">Belum ada foto dokumentasi</p>
                    <p class="text-gray-400 text-sm">Upload foto kegiatan qurban untuk memulai galeri</p>
                </div>
            </div>



            <!-- Laporan Tab -->
            <div id="laporan-tab" class="tab-content hidden">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold text-gray-800">Laporan Data Qurban</h3>
                    <div class="flex items-center space-x-4">
                        <select id="filterLaporanTahun" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-emerald-500">
                            <option value="2024">1445H / 2024</option>
                            <option value="2023">1444H / 2023</option>
                            <option value="2022">1443H / 2022</option>
                            <option value="2021">1442H / 2021</option>
                        </select>
                        <select id="filterLaporanJenis" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-emerald-500">
                            <option value="">Laporan Lengkap</option>
                            <option value="panitia">Data Pequrban</option>
                            <option value="hewan">Data Hewan</option>
                            <option value="pequrban">Data Panitia</option>
                            <option value="mustahik">Data Mustahik</option>
                            <option value="guru">Data Guru & Sepuh</option>
                            <option value="sapi">Hewan Sapi Saja</option>
                            <option value="kambing">Hewan Kambing Saja</option>
                        </select>
                        <button id="exportBtn" class="admin-only hidden bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg">
                            <i class="fas fa-file-pdf mr-2"></i>Export ke PDF
                        </button>
                    </div>
                </div>

                <!-- Report Header -->
                <div class="bg-gradient-to-r from-emerald-600 to-emerald-700 text-white p-6 rounded-t-lg">
                    <div class="text-center">
                        <h2 class="text-2xl font-bold mb-2">LAPORAN PANITA QURBAN</h2>
                        <h3 class="text-lg">MUSHOLLA NURUL FALAH (MNF)</h3>
                        <p id="laporanPeriode" class="text-emerald-100 mt-2">Periode: <span id="periodeTahun"></span></p>
                        <p class="text-emerald-100 text-sm">Tanggal Cetak: <span id="tanggalCetak"></span></p>
                    </div>
                </div>

                <!-- Report Content -->
                <div class="bg-blue-100 border-l border-r border-gray-200 p-6">
                    <!-- Summary Cards -->
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-7 gap-4 mb-8">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-blue-600" id="laporanTotalPanitia">0</div>
                            <div class="text-sm text-blue-600 font-medium">Total Panitia</div>
                        </div>
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-green-600" id="laporanTotalHewan">0</div>
                            <div class="text-sm text-green-600 font-medium">Total Hewan</div>
                        </div>
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-red-600" id="laporanTotalPequrban">0</div>
                            <div class="text-sm text-red-600 font-medium">Total Pequrban</div>
                        </div>
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-blue-600" id="laporanTotalSapi">0</div>
                            <div class="text-sm text-blue-600 font-medium">Total Sapi</div>
                        </div>
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-green-600" id="laporanTotalKambing">0</div>
                            <div class="text-sm text-green-600 font-medium">Total Kambing</div>
                        </div>
                        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-purple-600" id="laporanTotalMustahik">0</div>
                            <div class="text-sm text-purple-600 font-medium">Total Mustahik</div>
                        </div>
                        <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-indigo-600" id="laporanTotalGuru">0</div>
                            <div class="text-sm text-indigo-600 font-medium">Guru & Sepuh</div>
                        </div>
                    </div>

                    <!-- Detailed Tables -->
                    <div class="space-y-8">
                        <!-- Hewan Qurban Table -->
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <i class="fas fa-cow text-blue-600 mr-2"></i>
                                Rincian Hewan Qurban
                            </h4>
                            <div class="overflow-x-auto">
                                <table class="min-w-full border border-gray-300">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase border border-gray-300">No</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase border border-gray-300">Jenis Hewan</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase border border-gray-300">Nama Sapi</th>
                                            <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase border border-gray-300">Jumlah Pemilik</th>
                
                                            <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase border border-gray-300">Tahun</th>
                                        </tr>
                                    </thead>
                                    <tbody id="laporanHewanTable" class="bg-white">
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Mustahik Table -->
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <i class="fas fa-hand-holding-heart text-purple-600 mr-2"></i>
                                Distribusi Mustahik per RT
                            </h4>
                            <div class="overflow-x-auto">
                                <table class="min-w-full border border-gray-300">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase border border-gray-300">RT</th>
                                            <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase border border-gray-300">Jumlah Mustahik</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase border border-gray-300">Persentase</th>
                                        </tr>
                                    </thead>
                                    <tbody id="laporanMustahikTable" class="bg-white">
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Panitia Table -->
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <i class="fas fa-users text-emerald-600 mr-2"></i>
                                Data Panitia
                            </h4>
                            <div class="overflow-x-auto">
                                <table class="min-w-full border border-gray-300">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase border border-gray-300">No</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase border border-gray-300">Nama</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase border border-gray-300">Jabatan</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase border border-gray-300">No. HP</th>
                                            <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase border border-gray-300">Tahun</th>
                                        </tr>
                                    </thead>
                                    <tbody id="laporanPanitiaTable" class="bg-white">
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Pequrban Table -->
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <i class="fas fa-users text-orange-600 mr-2"></i>
                                Data Lengkap Pequrban (Pemilik Hewan)
                            </h4>
                            <div class="overflow-x-auto">
                                <table class="min-w-full border border-gray-300">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase border border-gray-300">No</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase border border-gray-300">Nama Pequrban</th>
                                            <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase border border-gray-300">Jenis Hewan</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase border border-gray-300">Nama Sapi</th>
                                            <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase border border-gray-300">Tahun</th>
                                        </tr>
                                    </thead>
                                    <tbody id="laporanPequrbanTable" class="bg-white">
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Guru & Sepuh Table -->
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <i class="fas fa-chalkboard-teacher text-indigo-600 mr-2"></i>
                                Data Guru & Sepuh
                            </h4>
                            <div class="overflow-x-auto">
                                <table class="min-w-full border border-gray-300">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase border border-gray-300">No</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase border border-gray-300">Nama</th>
                                            <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase border border-gray-300">Kategori</th>
                                            <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase border border-gray-300">Tahun</th>
                                        </tr>
                                    </thead>
                                    <tbody id="laporanGuruTable" class="bg-white">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Report Footer -->
                <div class="bg-gray-50 border border-gray-200 rounded-b-lg p-6">
                    <div class="text-center text-sm text-gray-600">
                        <p class="mb-2">Laporan ini dibuat secara otomatis oleh Sistem Manajemen Qurban MNF</p>
                        <p>© 2025 Musholla Nurul Falah - Semua data telah diverifikasi</p>
                    </div>
                </div>
            </div>

            <!-- Backup & Restore Tab -->
            
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 modal hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
            <h3 class="text-xl font-semibold text-gray-800 mb-6 text-center">Login Admin</h3>
            <form id="loginForm">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Email</label>
                    <input type="email" id="loginEmail" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-emerald-500" required>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Password</label>
                    <input type="password" id="loginPassword" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-emerald-500" required>
                </div>
                <div class="flex justify-between">
                    <button type="button" id="cancelLogin" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">Batal</button>
                    <button type="submit" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg">Login</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add/Edit Modals -->
    <div id="panitiaModal" class="fixed inset-0 bg-black bg-opacity-50 modal hidden flex items-center justify-center z-50">
        <div class="bg-gradient-to-br rounded-lg p-8 max-w-md w-full mx-4">
            <h3 id="panitiaModalTitle" class="text-xl font-semibold text-gray-800 mb-6">Tambah Panitia</h3>
            <form id="panitiaForm">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Nama</label>
                    <input type="text" id="panitiaNama" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-emerald-500" required>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Jabatan</label>
                    <input type="text" id="panitiaJabatan" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-emerald-500" required>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">No. HP</label>
                    <input type="tel" id="panitiaHP" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-emerald-500" required>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Tahun</label>
                    <select id="panitiaTahun" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-emerald-500" required>
                        <option value="2024">1445H / 2024</option>
                        <option value="2023">1444H / 2023</option>
                        <option value="2022">1443H / 2022</option>
                        <option value="2021">1442H / 2021</option>
                    </select>
                </div>
                <div class="flex justify-between">
                    <button type="button" class="cancel-btn bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">Batal</button>
                    <button type="submit" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <div id="hewanModal" class="fixed inset-0 bg-black bg-opacity-50 modal hidden flex items-center justify-center z-50">
        <div class="bg-emerald-100 rounded-lg p-8 max-w-lg w-full mx-4 max-h-96 overflow-y-auto">
            <h3 id="hewanModalTitle" class="text-xl font-semibold text-gray-800 mb-6">Tambah Hewan Qurban</h3>
            <form id="hewanForm">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Jenis Hewan</label>
                    <select id="hewanJenis" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-emerald-500" required>
                        <option value="">Pilih Jenis</option>
                        <option value="kambing">Kambing</option>
                        <option value="sapi">Sapi</option>
                    </select>
                </div>
                <div id="sapiTypeContainer" class="mb-4 hidden">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Jenis Sapi</label>
                    <select id="sapiType" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-emerald-500">
                        <option value="">Pilih Sapi</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Tahun</label>
                    <select id="hewanTahun" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-emerald-500" required>
                        <option value="2024">1445H / 2024</option>
                        <option value="2023">1444H / 2023</option>
                        <option value="2022">1443H / 2022</option>
                        <option value="2021">1442H / 2021</option>
                    </select>
                </div>
                <div id="pemilikContainer" class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Nama Pemilik</label>
                    <div id="pemilikList">
                        <input type="text" class="pemilik-input w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-emerald-500 mb-2" placeholder="Nama pemilik 1" required>
                    </div>
                    <button type="button" id="addPemilik" class="text-blue-600 hover:text-blue-800 text-sm">+ Tambah Pemilik</button>
                </div>
                <div class="flex justify-between">
                    <button type="button" class="cancel-btn bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">Batal</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <div id="mustahikModal" class="fixed inset-0 bg-black bg-opacity-50 modal hidden flex items-center justify-center z-50">
        <div class="bg-blue-100 rounded-lg p-8 max-w-md w-full mx-4">
            <h3 id="mustahikModalTitle" class="text-xl font-semibold text-gray-800 mb-6">Tambah Mustahik</h3>
            <form id="mustahikForm">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Nama Mustahik</label>
                    <input type="text" id="mustahikNama" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-purple-500" required>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">RT</label>
                    <select id="mustahikRT" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-purple-500" required>
                        <option value="">Pilih RT</option>
                        <option value="RT 10/04">RT 10/04</option>
                        <option value="RT 03/04">RT 03/04</option>
                        <option value="RT 04/04">RT 04/04</option>
                        <option value="RT 02/03">RT 02/03</option>
                        <option value="RT 03/03">RT 03/03</option>
                    </select>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Tahun</label>
                    <select id="mustahikTahun" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-purple-500" required>
                        <option value="2024">1445H / 2024</option>
                        <option value="2023">1444H / 2023</option>
                        <option value="2022">1443H / 2022</option>
                        <option value="2021">1442H / 2021</option>
                    </select>
                </div>
                <div class="flex justify-between">
                    <button type="button" class="cancel-btn bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">Batal</button>
                    <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <div id="guruModal" class="fixed inset-0 bg-black bg-opacity-50 modal hidden flex items-center justify-center z-50">
        <div class="bg-emerald-100 rounded-lg p-8 max-w-md w-full mx-4">
            <h3 id="guruModalTitle" class="text-xl font-semibold text-gray-800 mb-6">Tambah Guru/Sepuh</h3>
            <form id="guruForm">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Nama</label>
                    <input type="text" id="guruNama" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-emerald-500" required>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Kategori</label>
                    <select id="guruKategori" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-emerald-500" required>
                        <option value="">Pilih Kategori</option>
                        <option value="guru">Guru</option>
                        <option value="sepuh">Sepuh</option>
                        <option value="tokoh">Tokoh Masyarakat</option>
                    </select>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Tahun</label>
                    <select id="guruTahun" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-500" required>
                        <option value="2024">1445H / 2024</option>
                        <option value="2023">1444H / 2023</option>
                        <option value="2022">1443H / 2022</option>
                        <option value="2021">1442H / 2021</option>
                    </select>
                </div>
                <div class="flex justify-between">
                    <button type="button" class="cancel-btn bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">Batal</button>
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <div id="fotoModal" class="fixed inset-0 bg-black bg-opacity-50 modal hidden flex items-center justify-center z-50">
        <div class="bg-blue-100 rounded-lg p-8 max-w-lg w-full mx-4 max-h-96 overflow-y-auto">
            <h3 class="text-xl font-semibold text-gray-800 mb-6">Upload Foto Kegiatan Qurban</h3>
            <form id="fotoForm">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Pilih Foto (Bisa Multiple)</label>
                    <input type="file" id="fotoFile" accept="image/jpeg,image/jpg,image/png,image/gif" multiple class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-orange-500" required>
                    <p class="text-xs text-gray-500 mt-1">Bisa pilih beberapa foto sekaligus. Format: JPG, JPEG, PNG, GIF (Maks 5MB per foto)</p>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Tahun Kegiatan</label>
                    <select id="fotoTahun" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-orange-500" required>
                        <option value="2024">1445H / 2024</option>
                        <option value="2023">1444H / 2023</option>
                        <option value="2022">1443H / 2022</option>
                        <option value="2021">1442H / 2021</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Kategori Kegiatan</label>
                    <select id="fotoKategori" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-orange-500" required>
                        <option value="">Pilih Kategori</option>
                        <option value="persiapan">Persiapan Qurban</option>
                        <option value="penyembelihan">Penyembelihan</option>
                        <option value="pengolahan">Pengolahan Daging</option>
                        <option value="pembagian">Pembagian Daging</option>
                        <option value="panitia">Kegiatan Panitia</option>
                        <option value="lainnya">Lainnya</option>
                    </select>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Keterangan</label>
                    <textarea id="fotoKeterangan" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-orange-500" placeholder="Deskripsi kegiatan atau keterangan foto..." required></textarea>
                </div>
                <div class="flex justify-between">
                    <button type="button" class="cancel-btn bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">Batal</button>
                    <button type="submit" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-upload mr-2"></i>Upload Foto
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Photo View Modal -->
    <div id="photoViewModal" class="fixed inset-0 bg-black bg-opacity-90 modal hidden flex items-center justify-center z-50">
        <div class="relative max-w-4xl max-h-full p-4">
            <button id="closePhotoView" class="absolute top-2 right-2 text-white hover:text-gray-300 text-2xl z-10">
                <i class="fas fa-times"></i>
            </button>
            <img id="photoViewImage" src="" alt="" class="max-w-full max-h-full object-contain rounded-lg">
            <div class="absolute bottom-4 left-4 right-4 bg-black bg-opacity-70 text-white p-4 rounded-lg">
                <h4 id="photoViewTitle" class="font-semibold mb-1"></h4>
                <p id="photoViewDescription" class="text-sm text-gray-300 mb-2"></p>
                <div class="flex items-center justify-between text-xs text-gray-400">
                    <span id="photoViewCategory"></span>
                    <span id="photoViewYear"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-600 mx-auto mb-4"></div>
            <p class="text-gray-700">Memproses...</p>
        </div>
    </div>

    <script>
        // Firebase Configuration - Replace with your actual config
       const firebaseConfig = {
    apiKey: "AIzaSyCVQovn9-8D_Immb4nb9uafDx4bfA-q5oM",
    authDomain: "panitiaqurban-mnf.firebaseapp.com",
    projectId: "panitiaqurban-mnf",
    storageBucket: "panitiaqurban-mnf.firebasestorage.app",
    messagingSenderId: "976258695981",
    appId: "1:976258695981:web:d489100fa156439fce89a4"
  };

        // Initialize Firebase - PRODUCTION MODE
        let isDemo = false; // Set to true for demo mode, false for Firebase
        let currentUser = null;
        let demoData = {
            panitia: [
                { id: '1', nama: 'Ahmad Fauzi', jabatan: 'Ketua Panitia', hp: '081234567890', tahun: '2024' },
                { id: '2', nama: 'Siti Aminah', jabatan: 'Sekretaris', hp: '081234567891', tahun: '2024' },
                { id: '3', nama: 'Muhammad Yusuf', jabatan: 'Bendahara', hp: '081234567892', tahun: '2024' },
                { id: '4', nama: 'Umar Hakim', jabatan: 'Koordinator Lapangan', hp: '081234567893', tahun: '2024' },
                { id: '5', nama: 'Hasan Abdullah', jabatan: 'Ketua Panitia', hp: '081234567894', tahun: '2023' },
                { id: '6', nama: 'Fatimah Zahra', jabatan: 'Sekretaris', hp: '081234567895', tahun: '2023' },
                { id: '7', nama: 'Ali Rahman', jabatan: 'Bendahara', hp: '081234567896', tahun: '2023' },
                { id: '8', nama: 'Khadijah Sari', jabatan: 'Koordinator Lapangan', hp: '081234567897', tahun: '2022' },
                { id: '9', nama: 'Omar Faruq', jabatan: 'Ketua Panitia', hp: '081234567898', tahun: '2022' }
            ],
            hewan: [
                { id: '1', jenis: 'sapi', sapiType: 'Sapi 1', pemilik: ['Ahmad Ali', 'Budi Santoso', 'Citra Dewi', 'Dedi Rahman', 'Eka Sari', 'Farid Hakim', 'Gina Putri'], tahun: '2024' },
                { id: '2', jenis: 'kambing', pemilik: ['Hasan Ibrahim'], tahun: '2024' },
                { id: '3', jenis: 'kambing', pemilik: ['Indira Sari'], tahun: '2024' },
                { id: '4', jenis: 'sapi', sapiType: 'Sapi 2', pemilik: ['Pak Bambang', 'Bu Ratna', 'Mas Agus', 'Mbak Sari', 'Pak Dedi', 'Bu Rina', 'Mas Joko'], tahun: '2024' },
                { id: '5', jenis: 'sapi', sapiType: 'Sapi 3', pemilik: ['Ali Rahman', 'Siti Khadijah', 'Umar Faruq', 'Aisyah Putri', 'Hamzah Malik', 'Zainab Sari', 'Yusuf Hakim'], tahun: '2024' }
            ],
            mustahik: [
                { id: '1', nama: 'Pak Sukirman', rt: 'RT 01', tahun: '2024' },
                { id: '2', nama: 'Bu Suminah', rt: 'RT 02', tahun: '2024' },
                { id: '3', nama: 'Keluarga Budi', rt: 'RT 01', tahun: '2024' },
                { id: '4', nama: 'Ibu Sari', rt: 'RT 03', tahun: '2024' },
                { id: '5', nama: 'Pak Joko', rt: 'RT 02', tahun: '2024' },
                { id: '6', nama: 'Bu Ani', rt: 'RT 01', tahun: '2024' },
                { id: '7', nama: 'Pak Ahmad', rt: 'RT 04', tahun: '2023' },
                { id: '8', nama: 'Bu Fatimah', rt: 'RT 05', tahun: '2023' },
                { id: '9', nama: 'Keluarga Hasan', rt: 'RT 03', tahun: '2023' },
                { id: '10', nama: 'Bu Khadijah', rt: 'RT 01', tahun: '2022' }
            ],
            guru: [
                { id: '1', nama: 'Ustadz Abdullah', kategori: 'guru', tahun: '2024' },
                { id: '2', nama: 'Kyai Hasan', kategori: 'sepuh', tahun: '2024' },
                { id: '3', nama: 'Pak RT Sukiman', kategori: 'tokoh', tahun: '2024' },
                { id: '4', nama: 'Ustadz Mahmud', kategori: 'guru', tahun: '2024' },
                { id: '5', nama: 'Mbah Karno', kategori: 'sepuh', tahun: '2024' },
                { id: '6', nama: 'Ustadz Ahmad', kategori: 'guru', tahun: '2023' },
                { id: '7', nama: 'Kyai Umar', kategori: 'sepuh', tahun: '2023' },
                { id: '8', nama: 'Pak RW Bambang', kategori: 'tokoh', tahun: '2023' },
                { id: '9', nama: 'Ustadz Yusuf', kategori: 'guru', tahun: '2022' }
            ],
            galeri: [
                { id: '1', url: 'https://via.placeholder.com/150x150/10b981/ffffff?text=Sapi+1', keterangan: 'Penyembelihan sapi qurban pertama', kategori: 'penyembelihan', tahun: '2024' },
                { id: '2', url: 'https://via.placeholder.com/150x150/3b82f6/ffffff?text=Bagikan', keterangan: 'Pembagian daging kepada mustahik RT 01', kategori: 'pembagian', tahun: '2024' },
                { id: '3', url: 'https://via.placeholder.com/150x150/8b5cf6/ffffff?text=Panitia', keterangan: 'Foto bersama panitia qurban 1445H', kategori: 'panitia', tahun: '2024' },
                { id: '4', url: 'https://via.placeholder.com/150x150/f59e0b/ffffff?text=Siap', keterangan: 'Persiapan alat dan tempat penyembelihan', kategori: 'persiapan', tahun: '2024' },
                { id: '5', url: 'https://via.placeholder.com/150x150/ef4444/ffffff?text=Olah', keterangan: 'Proses pengolahan dan pemotongan daging', kategori: 'pengolahan', tahun: '2024' },
                { id: '6', url: 'https://via.placeholder.com/150x150/06b6d4/ffffff?text=Kambing', keterangan: 'Penyembelihan kambing qurban', kategori: 'penyembelihan', tahun: '2024' },
                { id: '7', url: 'https://via.placeholder.com/150x150/84cc16/ffffff?text=Bagi+2', keterangan: 'Pembagian daging untuk guru dan sepuh', kategori: 'pembagian', tahun: '2024' },
                { id: '8', url: 'https://via.placeholder.com/150x150/f97316/ffffff?text=Masak', keterangan: 'Memasak gulai untuk acara bersama', kategori: 'pengolahan', tahun: '2024' },
                { id: '9', url: 'https://via.placeholder.com/150x150/a855f7/ffffff?text=2023', keterangan: 'Dokumentasi qurban tahun lalu', kategori: 'panitia', tahun: '2023' },
                { id: '10', url: 'https://via.placeholder.com/150x150/ec4899/ffffff?text=Sapi+2023', keterangan: 'Penyembelihan sapi tahun 2023', kategori: 'penyembelihan', tahun: '2023' },
                { id: '11', url: 'https://via.placeholder.com/150x150/14b8a6/ffffff?text=Bagi+2023', keterangan: 'Pembagian daging tahun 2023', kategori: 'pembagian', tahun: '2023' },
                { id: '12', url: 'https://via.placeholder.com/150x150/6366f1/ffffff?text=2022', keterangan: 'Kegiatan qurban tahun 2022', kategori: 'lainnya', tahun: '2022' }
            ]
        };

        // Initialize Firebase
        let db, auth, storage;
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            if (isDemo) {
                console.log('Running in DEMO mode - Replace with actual Firebase config');
                initializeApp();
            } else {
                // Initialize Firebase
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                auth = firebase.auth();
                storage = firebase.storage();
                
                // Listen for auth state changes
                auth.onAuthStateChanged((user) => {
                    if (user) {
                        currentUser = user;
                        updateUIForLoggedInUser();
                    } else {
                        currentUser = null;
                        updateUIForLoggedOutUser();
                    }
                });
                
                initializeApp();
            }
            
            // Generate real-time year options
            generateYearOptions();
        });

        function initializeApp() {
            setupEventListeners();
            loadDashboardData();
            showTab('panitia');
        }

        function setupEventListeners() {
            // Tab navigation
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tab = btn.dataset.tab;
                    showTab(tab);
                });
            });

            // Login/Logout
            document.getElementById('loginBtn').addEventListener('click', () => {
                document.getElementById('loginModal').classList.remove('hidden');
            });

            document.getElementById('logoutBtn').addEventListener('click', logout);
            document.getElementById('cancelLogin').addEventListener('click', () => {
                document.getElementById('loginModal').classList.add('hidden');
            });

            document.getElementById('loginForm').addEventListener('submit', handleLogin);

            // Add buttons
            document.getElementById('addPanitiaBtn').addEventListener('click', () => openModal('panitiaModal'));
            document.getElementById('addHewanBtn').addEventListener('click', () => openModal('hewanModal'));
            document.getElementById('addMustahikBtn').addEventListener('click', () => openModal('mustahikModal'));
            document.getElementById('addGuruBtn').addEventListener('click', () => openModal('guruModal'));
            document.getElementById('addFotoBtn').addEventListener('click', () => openModal('fotoModal'));

            // Cancel buttons
            document.querySelectorAll('.cancel-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const modal = e.target.closest('.modal');
                    modal.classList.add('hidden');
                    // Reset edit mode when canceling
                    editMode = { isEditing: false, type: null, id: null };
                });
            });

            // Forms
            document.getElementById('panitiaForm').addEventListener('submit', handlePanitiaSubmit);
            document.getElementById('hewanForm').addEventListener('submit', handleHewanSubmit);
            document.getElementById('mustahikForm').addEventListener('submit', handleMustahikSubmit);
            document.getElementById('guruForm').addEventListener('submit', handleGuruSubmit);
            document.getElementById('fotoForm').addEventListener('submit', handleFotoSubmit);

            // Dynamic pemilik for hewan
            document.getElementById('addPemilik').addEventListener('click', addPemilikField);
            document.getElementById('hewanJenis').addEventListener('change', updatePemilikFields);
            document.getElementById('hewanJenis').addEventListener('change', updateSapiOptions);

            // Export button
            document.getElementById('exportBtn').addEventListener('click', exportLaporan);

            // Year selector
            document.getElementById('yearSelector').addEventListener('change', loadDashboardData);

            // Panitia filters
            document.getElementById('filterPanitiaTahun').addEventListener('change', loadPanitiaData);
            document.getElementById('searchPanitia').addEventListener('input', loadPanitiaData);
            document.getElementById('resetFilterPanitia').addEventListener('click', resetPanitiaFilters);
            
            // Hewan filters
            document.getElementById('filterHewanTahun').addEventListener('change', loadHewanData);
            document.getElementById('filterHewanJenis').addEventListener('change', loadHewanData);
            document.getElementById('searchHewan').addEventListener('input', loadHewanData);
            document.getElementById('resetFilterHewan').addEventListener('click', resetHewanFilters);
            
            // Mustahik filters
            document.getElementById('filterMustahikTahun').addEventListener('change', loadMustahikData);
            document.getElementById('filterMustahikRT').addEventListener('change', loadMustahikData);
            document.getElementById('searchMustahik').addEventListener('input', loadMustahikData);
            document.getElementById('resetFilterMustahik').addEventListener('click', resetMustahikFilters);
            
            // Guru filters
            document.getElementById('filterGuruTahun').addEventListener('change', loadGuruData);
            document.getElementById('filterGuruKategori').addEventListener('change', loadGuruData);
            document.getElementById('searchGuru').addEventListener('input', loadGuruData);
            document.getElementById('resetFilterGuru').addEventListener('click', resetGuruFilters);
            
            // Galeri filters
            document.getElementById('filterGaleriTahun').addEventListener('change', loadGaleriData);
            document.getElementById('searchGaleri').addEventListener('input', loadGaleriData);
            document.getElementById('resetFilterGaleri').addEventListener('click', resetGaleriFilters);
            
            // Laporan filter
            document.getElementById('filterLaporanTahun').addEventListener('change', loadLaporanData);
            document.getElementById('filterLaporanJenis').addEventListener('change', loadLaporanData);
            

            
            // Photo view modal
            document.getElementById('closePhotoView').addEventListener('click', () => {
                document.getElementById('photoViewModal').classList.add('hidden');
            });

            // Backup & Restore
           
            // Refresh button
            document.getElementById('refreshBtn').addEventListener('click', refreshAllData);
        }

        function showTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active', 'border-emerald-500', 'text-emerald-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active', 'border-emerald-500', 'text-emerald-600');
            document.querySelector(`[data-tab="${tabName}"]`).classList.remove('border-transparent', 'text-gray-500');

            // Show tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(`${tabName}-tab`).classList.remove('hidden');

            // Load data for the tab
            switch(tabName) {
                case 'panitia':
                    loadPanitiaData();
                    break;
                case 'hewan':
                    loadHewanData();
                    break;
                case 'mustahik':
                    loadMustahikData();
                    break;
                case 'guru':
                    loadGuruData();
                    break;
                case 'galeri':
                    loadGaleriData();
                    break;
                case 'laporan':
                    loadLaporanData();
                    break;
                case 'backup':
                    loadBackupData();
                    break;
            }
        }

        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            showLoading(true);

            if (isDemo) {
                // Demo login - accept any email/password
                setTimeout(() => {
                    currentUser = { email: email };
                    updateUIForLoggedInUser();
                    document.getElementById('loginModal').classList.add('hidden');
                    showLoading(false);
                }, 1000);
            } else {
                auth.signInWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        currentUser = userCredential.user;
                        document.getElementById('loginModal').classList.add('hidden');
                        showLoading(false);
                        // UI will be updated by onAuthStateChanged
                    })
                    .catch((error) => {
                        let errorMessage = 'Login gagal';
                        switch(error.code) {
                            case 'auth/user-not-found':
                                errorMessage = 'Email tidak terdaftar';
                                break;
                            case 'auth/wrong-password':
                                errorMessage = 'Password salah';
                                break;
                            case 'auth/invalid-email':
                                errorMessage = 'Format email tidak valid';
                                break;
                            case 'auth/too-many-requests':
                                errorMessage = 'Terlalu banyak percobaan login. Coba lagi nanti';
                                break;
                            default:
                                errorMessage = error.message;
                        }
                        alert(errorMessage);
                        showLoading(false);
                    });
            }
        }

        function logout() {
            if (isDemo) {
                currentUser = null;
                updateUIForLoggedOutUser();
            } else {
                auth.signOut().then(() => {
                    // UI will be updated by onAuthStateChanged
                }).catch((error) => {
                    console.error('Logout error:', error);
                    alert('Gagal logout: ' + error.message);
                });
            }
        }

        function updateUIForLoggedInUser() {
            document.getElementById('loginBtn').classList.add('hidden');
            document.getElementById('userInfo').classList.remove('hidden');
            document.getElementById('userEmail').textContent = currentUser.email;
            document.querySelectorAll('.admin-only').forEach(el => el.classList.remove('hidden'));
            
            // Reload current tab data to show admin buttons
            const activeTab = document.querySelector('.tab-btn.active');
            if (activeTab) {
                const tabName = activeTab.dataset.tab;
                switch(tabName) {
                    case 'panitia':
                        loadPanitiaData();
                        break;
                    case 'hewan':
                        loadHewanData();
                        break;
                    case 'mustahik':
                        loadMustahikData();
                        break;
                    case 'guru':
                        loadGuruData();
                        break;
                    case 'galeri':
                        loadGaleriData();
                        break;
                }
            }
        }

        function updateUIForLoggedOutUser() {
            document.getElementById('loginBtn').classList.remove('hidden');
            document.getElementById('userInfo').classList.add('hidden');
            document.querySelectorAll('.admin-only').forEach(el => el.classList.add('hidden'));
            
            // Reload current tab data to hide admin buttons
            const activeTab = document.querySelector('.tab-btn.active');
            if (activeTab) {
                const tabName = activeTab.dataset.tab;
                switch(tabName) {
                    case 'panitia':
                        loadPanitiaData();
                        break;
                    case 'hewan':
                        loadHewanData();
                        break;
                    case 'mustahik':
                        loadMustahikData();
                        break;
                    case 'guru':
                        loadGuruData();
                        break;
                    case 'galeri':
                        loadGaleriData();
                        break;
                }
            }
        }

        async function loadDashboardData() {
            const selectedYear = document.getElementById('yearSelector').value;
            
            if (isDemo) {
                // Filter data by selected year
                const panitiaYear = selectedYear ? demoData.panitia.filter(p => p.tahun === selectedYear) : demoData.panitia;
                const hewanYear = selectedYear ? demoData.hewan.filter(h => h.tahun === selectedYear) : demoData.hewan;
                const mustahikYear = selectedYear ? demoData.mustahik.filter(m => m.tahun === selectedYear) : demoData.mustahik;
                const guruYear = selectedYear ? demoData.guru.filter(g => g.tahun === selectedYear) : demoData.guru;
                const galeriYear = selectedYear ? demoData.galeri.filter(f => f.tahun === selectedYear) : demoData.galeri;

                updateDashboardUI(panitiaYear, hewanYear, mustahikYear, guruYear, galeriYear);
            } else {
                try {
                    showLoading(true);
                    
                    // Simplified queries to avoid index issues
                    let panitiaData = [];
                    let hewanData = [];
                    let mustahikData = [];
                    let guruData = [];
                    let galeriData = [];
                    
                    if (selectedYear) {
                        // Execute queries with year filter one by one
                        try {
                            const panitiaSnapshot = await db.collection('panitia').where('tahun', '==', selectedYear).get();
                            panitiaData = panitiaSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        } catch (e) {
                            console.warn('Panitia query failed, using fallback:', e);
                            const allPanitia = await db.collection('panitia').get();
                            panitiaData = allPanitia.docs.map(doc => ({ id: doc.id, ...doc.data() })).filter(p => p.tahun === selectedYear);
                        }
                        
                        try {
                            const hewanSnapshot = await db.collection('hewan').where('tahun', '==', selectedYear).get();
                            hewanData = hewanSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        } catch (e) {
                            console.warn('Hewan query failed, using fallback:', e);
                            const allHewan = await db.collection('hewan').get();
                            hewanData = allHewan.docs.map(doc => ({ id: doc.id, ...doc.data() })).filter(h => h.tahun === selectedYear);
                        }
                        
                        try {
                            const mustahikSnapshot = await db.collection('mustahik').where('tahun', '==', selectedYear).get();
                            mustahikData = mustahikSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        } catch (e) {
                            console.warn('Mustahik query failed, using fallback:', e);
                            const allMustahik = await db.collection('mustahik').get();
                            mustahikData = allMustahik.docs.map(doc => ({ id: doc.id, ...doc.data() })).filter(m => m.tahun === selectedYear);
                        }
                        
                        try {
                            const guruSnapshot = await db.collection('guru').where('tahun', '==', selectedYear).get();
                            guruData = guruSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        } catch (e) {
                            console.warn('Guru query failed, using fallback:', e);
                            const allGuru = await db.collection('guru').get();
                            guruData = allGuru.docs.map(doc => ({ id: doc.id, ...doc.data() })).filter(g => g.tahun === selectedYear);
                        }
                        
                        try {
                            const galeriSnapshot = await db.collection('galeri').where('tahun', '==', selectedYear).get();
                            galeriData = galeriSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        } catch (e) {
                            console.warn('Galeri query failed, using fallback:', e);
                            const allGaleri = await db.collection('galeri').get();
                            galeriData = allGaleri.docs.map(doc => ({ id: doc.id, ...doc.data() })).filter(f => f.tahun === selectedYear);
                        }
                    } else {
                        // Get all data without year filter
                        try {
                            const [panitiaSnapshot, hewanSnapshot, mustahikSnapshot, guruSnapshot, galeriSnapshot] = await Promise.all([
                                db.collection('panitia').get(),
                                db.collection('hewan').get(),
                                db.collection('mustahik').get(),
                                db.collection('guru').get(),
                                db.collection('galeri').get()
                            ]);
                            
                            panitiaData = panitiaSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            hewanData = hewanSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            mustahikData = mustahikSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            guruData = guruSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            galeriData = galeriSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        } catch (e) {
                            console.error('Failed to load all data:', e);
                            throw e;
                        }
                    }
                    
                    updateDashboardUI(panitiaData, hewanData, mustahikData, guruData, galeriData);
                    showLoading(false);
                    
                } catch (error) {
                    console.error('Error loading dashboard data:', error);
                    alert('Gagal memuat data dashboard. Silakan coba lagi atau hubungi administrator.');
                    showLoading(false);
                }
            }
        }
        
        function updateDashboardUI(panitiaYear, hewanYear, mustahikYear, guruYear, galeriYear) {
            // Main dashboard cards
            document.getElementById('totalPanitia').textContent = panitiaYear.length;
            document.getElementById('totalHewan').textContent = hewanYear.length;
            document.getElementById('totalMustahik').textContent = mustahikYear.length;
            document.getElementById('totalFoto').textContent = galeriYear.length;

            // Calculate pequrban (total people who own animals)
            const totalPequrban = hewanYear.reduce((total, hewan) => total + (hewan.pemilik ? hewan.pemilik.length : 0), 0);
            document.getElementById('totalPequrban').textContent = totalPequrban;

            // Detailed statistics
            const sapiCount = hewanYear.filter(h => h.jenis === 'sapi').length;
            const kambingCount = hewanYear.filter(h => h.jenis === 'kambing').length;

            document.getElementById('totalSapi').textContent = `${sapiCount} ekor`;
            document.getElementById('totalKambing').textContent = `${kambingCount} ekor`;

            // Guru & Sepuh statistics
            const guruCount = guruYear.filter(g => g.kategori === 'guru').length;
            const sepuhCount = guruYear.filter(g => g.kategori === 'sepuh').length;
            const tokohCount = guruYear.filter(g => g.kategori === 'tokoh').length;

            document.getElementById('totalGuru').textContent = `${guruCount} orang`;
            document.getElementById('totalSepuh').textContent = `${sepuhCount} orang`;
            document.getElementById('totalTokoh').textContent = `${tokohCount} orang`;
            document.getElementById('totalGuruSepuh').textContent = `${guruYear.length} orang`;

            // Mustahik per RT
            const rtStats = {};
            mustahikYear.forEach(m => {
                rtStats[m.rt] = (rtStats[m.rt] || 0) + 1;
            });

            const mustahikPerRTContainer = document.getElementById('mustahikPerRT');
            mustahikPerRTContainer.innerHTML = '';
            Object.entries(rtStats).forEach(([rt, count]) => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center';
                div.innerHTML = `
                    <span class="text-gray-600">${rt}</span>
                    <span class="font-semibold text-gray-800">${count} mustahik</span>
                `;
                mustahikPerRTContainer.appendChild(div);
            });
        }

        async function loadPanitiaData() {
            const tbody = document.getElementById('panitiaTable');
            tbody.innerHTML = '';

            if (isDemo) {
                let filteredData = [...demoData.panitia];
                
                // Apply year filter
                const yearFilter = document.getElementById('filterPanitiaTahun').value;
                if (yearFilter) {
                    filteredData = filteredData.filter(p => p.tahun === yearFilter);
                }
                
                // Apply search filter
                const searchTerm = document.getElementById('searchPanitia').value.toLowerCase();
                if (searchTerm) {
                    filteredData = filteredData.filter(p => 
                        p.nama.toLowerCase().includes(searchTerm) ||
                        p.jabatan.toLowerCase().includes(searchTerm)
                    );
                }
                
                // Sort by year (newest first) then by name
                filteredData.sort((a, b) => {
                    if (a.tahun !== b.tahun) {
                        return b.tahun.localeCompare(a.tahun);
                    }
                    return a.nama.localeCompare(b.nama);
                });
                
                filteredData.forEach((panitia, index) => {
                    const row = createPanitiaRow(panitia, index + 1);
                    tbody.appendChild(row);
                });
                
                // Show no data message if empty
                if (filteredData.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td colspan="6" class="px-6 py-8 text-center text-gray-500 border-b border-gray-200">
                            <i class="fas fa-search text-3xl mb-2 block"></i>
                            Tidak ada data panitia yang ditemukan
                        </td>
                    `;
                    tbody.appendChild(row);
                }
            } else {
                try {
                    showLoading(true);
                    
                    // Build query - simplified to avoid index requirements
                    let query = db.collection('panitia');
                    
                    // Apply year filter if specified
                    const yearFilter = document.getElementById('filterPanitiaTahun').value;
                    if (yearFilter) {
                        query = query.where('tahun', '==', yearFilter);
                    }
                    
                    // Simple ordering - only by one field to avoid composite index requirement
                    query = query.orderBy('tahun', 'desc');
                    
                    const snapshot = await query.get();
                    let panitiaData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // Apply search filter (client-side for complex text search)
                    const searchTerm = document.getElementById('searchPanitia').value.toLowerCase();
                    if (searchTerm) {
                        panitiaData = panitiaData.filter(p => 
                            p.nama.toLowerCase().includes(searchTerm) ||
                            p.jabatan.toLowerCase().includes(searchTerm)
                        );
                    }
                    
                    // Sort by name client-side after filtering
                    panitiaData.sort((a, b) => {
                        if (a.tahun !== b.tahun) {
                            return b.tahun.localeCompare(a.tahun);
                        }
                        return a.nama.localeCompare(b.nama);
                    });
                    
                    panitiaData.forEach((panitia, index) => {
                        const row = createPanitiaRow(panitia, index + 1);
                        tbody.appendChild(row);
                    });
                    
                    // Show no data message if empty
                    if (panitiaData.length === 0) {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td colspan="6" class="px-6 py-8 text-center text-gray-500 border-b border-gray-200">
                                <i class="fas fa-search text-3xl mb-2 block"></i>
                                Tidak ada data panitia yang ditemukan
                            </td>
                        `;
                        tbody.appendChild(row);
                    }
                    
                    showLoading(false);
                    
                } catch (error) {
                    console.error('Error loading panitia data:', error);
                    
                    // Fallback: try without any ordering if index error persists
                    try {
                        const yearFilter = document.getElementById('filterPanitiaTahun').value;
                        let fallbackQuery = db.collection('panitia');
                        
                        if (yearFilter) {
                            fallbackQuery = fallbackQuery.where('tahun', '==', yearFilter);
                        }
                        
                        const fallbackSnapshot = await fallbackQuery.get();
                        let fallbackData = fallbackSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        
                        // Apply search filter client-side
                        const searchTerm = document.getElementById('searchPanitia').value.toLowerCase();
                        if (searchTerm) {
                            fallbackData = fallbackData.filter(p => 
                                p.nama.toLowerCase().includes(searchTerm) ||
                                p.jabatan.toLowerCase().includes(searchTerm)
                            );
                        }
                        
                        // Sort client-side
                        fallbackData.sort((a, b) => {
                            if (a.tahun !== b.tahun) {
                                return b.tahun.localeCompare(a.tahun);
                            }
                            return a.nama.localeCompare(b.nama);
                        });
                        
                        fallbackData.forEach((panitia, index) => {
                            const row = createPanitiaRow(panitia, index + 1);
                            tbody.appendChild(row);
                        });
                        
                        if (fallbackData.length === 0) {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td colspan="6" class="px-6 py-8 text-center text-gray-500 border-b border-gray-200">
                                    <i class="fas fa-search text-3xl mb-2 block"></i>
                                    Tidak ada data panitia yang ditemukan
                                </td>
                            `;
                            tbody.appendChild(row);
                        }
                        
                        showLoading(false);
                        
                    } catch (fallbackError) {
                        console.error('Fallback query also failed:', fallbackError);
                        alert('Gagal memuat data panitia. Silakan coba lagi atau hubungi administrator.');
                        showLoading(false);
                    }
                }
            }
        }

        function createPanitiaRow(panitia, nomor) {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50 transition-colors duration-200';
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 border-b border-gray-200">${nomor}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 border-b border-gray-200">${panitia.nama}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 border-b border-gray-200">${panitia.jabatan}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 border-b border-gray-200">${panitia.hp}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 border-b border-gray-200">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-800">
                        ${panitia.tahun}
                    </span>
                </td>
                <td class="admin-only ${currentUser ? '' : 'hidden'} px-6 py-4 whitespace-nowrap text-sm font-medium border-b border-gray-200 text-center">
                    <button onclick="editPanitia('${panitia.id}')" class="text-indigo-600 hover:text-indigo-900 mr-3 px-2 py-1 rounded hover:bg-indigo-50">
                        <i class="fas fa-edit mr-1"></i>Edit
                    </button>
                    <button onclick="deletePanitia('${panitia.id}')" class="text-red-600 hover:text-red-900 px-2 py-1 rounded hover:bg-red-50">
                        <i class="fas fa-trash mr-1"></i>Hapus
                    </button>
                </td>
            `;
            return row;
        }

        async function loadHewanData() {
            const tbody = document.getElementById('hewanTable');
            tbody.innerHTML = '';

            if (isDemo) {
                let filteredData = [...demoData.hewan];
                
                // Apply year filter
                const yearFilter = document.getElementById('filterHewanTahun').value;
                if (yearFilter) {
                    filteredData = filteredData.filter(h => h.tahun === yearFilter);
                }
                
                // Apply jenis filter
                const jenisFilter = document.getElementById('filterHewanJenis').value;
                if (jenisFilter) {
                    filteredData = filteredData.filter(h => h.jenis === jenisFilter);
                }
                
                // Apply search filter
                const searchTerm = document.getElementById('searchHewan').value.toLowerCase();
                if (searchTerm) {
                    filteredData = filteredData.filter(h => 
                        h.pemilik.some(pemilik => pemilik.toLowerCase().includes(searchTerm)) ||
                        (h.sapiType && h.sapiType.toLowerCase().includes(searchTerm))
                    );
                }
                
                // Sort by year (newest first) then by jenis
                filteredData.sort((a, b) => {
                    if (a.tahun !== b.tahun) {
                        return b.tahun.localeCompare(a.tahun);
                    }
                    return a.jenis.localeCompare(b.jenis);
                });
                
                filteredData.forEach((hewan, index) => {
                    const row = createHewanRow(hewan, index + 1);
                    tbody.appendChild(row);
                });
                
                // Show no data message if empty
                if (filteredData.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td colspan="6" class="px-6 py-8 text-center text-gray-500 border-b border-gray-200">
                            <i class="fas fa-search text-3xl mb-2 block"></i>
                            Tidak ada data hewan yang ditemukan
                        </td>
                    `;
                    tbody.appendChild(row);
                }
            } else {
                try {
                    showLoading(true);
                    
                    // Build query - simplified to avoid composite index requirements
                    let query = db.collection('hewan');
                    
                    // Apply filters one at a time to avoid complex composite indexes
                    const yearFilter = document.getElementById('filterHewanTahun').value;
                    const jenisFilter = document.getElementById('filterHewanJenis').value;
                    
                    if (yearFilter && jenisFilter) {
                        // If both filters are applied, use the most selective one in query
                        query = query.where('tahun', '==', yearFilter).where('jenis', '==', jenisFilter);
                    } else if (yearFilter) {
                        query = query.where('tahun', '==', yearFilter);
                    } else if (jenisFilter) {
                        query = query.where('jenis', '==', jenisFilter);
                    }
                    
                    // Simple ordering by one field only
                    query = query.orderBy('tahun', 'desc');
                    
                    const snapshot = await query.get();
                    let hewanData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // Apply remaining filters client-side
                    if (yearFilter && jenisFilter) {
                        // Both already applied in query
                    } else if (yearFilter && !jenisFilter) {
                        // Year already applied, filter jenis client-side if needed
                        const clientJenisFilter = document.getElementById('filterHewanJenis').value;
                        if (clientJenisFilter) {
                            hewanData = hewanData.filter(h => h.jenis === clientJenisFilter);
                        }
                    } else if (!yearFilter && jenisFilter) {
                        // Jenis already applied, filter year client-side if needed
                        const clientYearFilter = document.getElementById('filterHewanTahun').value;
                        if (clientYearFilter) {
                            hewanData = hewanData.filter(h => h.tahun === clientYearFilter);
                        }
                    }
                    
                    // Apply search filter (client-side for array search)
                    const searchTerm = document.getElementById('searchHewan').value.toLowerCase();
                    if (searchTerm) {
                        hewanData = hewanData.filter(h => 
                            h.pemilik && h.pemilik.some(pemilik => pemilik.toLowerCase().includes(searchTerm)) ||
                            (h.sapiType && h.sapiType.toLowerCase().includes(searchTerm))
                        );
                    }
                    
                    // Sort client-side
                    hewanData.sort((a, b) => {
                        if (a.tahun !== b.tahun) {
                            return b.tahun.localeCompare(a.tahun);
                        }
                        return a.jenis.localeCompare(b.jenis);
                    });
                    
                    hewanData.forEach((hewan, index) => {
                        const row = createHewanRow(hewan, index + 1);
                        tbody.appendChild(row);
                    });
                    
                    // Show no data message if empty
                    if (hewanData.length === 0) {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td colspan="6" class="px-6 py-8 text-center text-gray-500 border-b border-gray-200">
                                <i class="fas fa-search text-3xl mb-2 block"></i>
                                Tidak ada data hewan yang ditemukan
                            </td>
                        `;
                        tbody.appendChild(row);
                    }
                    
                    showLoading(false);
                    
                } catch (error) {
                    console.error('Error loading hewan data:', error);
                    
                    // Fallback: simple query without complex filtering
                    try {
                        let fallbackQuery = db.collection('hewan');
                        const fallbackSnapshot = await fallbackQuery.get();
                        let fallbackData = fallbackSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        
                        // Apply all filters client-side
                        const yearFilter = document.getElementById('filterHewanTahun').value;
                        const jenisFilter = document.getElementById('filterHewanJenis').value;
                        const searchTerm = document.getElementById('searchHewan').value.toLowerCase();
                        
                        if (yearFilter) {
                            fallbackData = fallbackData.filter(h => h.tahun === yearFilter);
                        }
                        
                        if (jenisFilter) {
                            fallbackData = fallbackData.filter(h => h.jenis === jenisFilter);
                        }
                        
                        if (searchTerm) {
                            fallbackData = fallbackData.filter(h => 
                                h.pemilik && h.pemilik.some(pemilik => pemilik.toLowerCase().includes(searchTerm)) ||
                                (h.sapiType && h.sapiType.toLowerCase().includes(searchTerm))
                            );
                        }
                        
                        // Sort client-side
                        fallbackData.sort((a, b) => {
                            if (a.tahun !== b.tahun) {
                                return b.tahun.localeCompare(a.tahun);
                            }
                            return a.jenis.localeCompare(b.jenis);
                        });
                        
                        fallbackData.forEach((hewan, index) => {
                            const row = createHewanRow(hewan, index + 1);
                            tbody.appendChild(row);
                        });
                        
                        if (fallbackData.length === 0) {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td colspan="6" class="px-6 py-8 text-center text-gray-500 border-b border-gray-200">
                                    <i class="fas fa-search text-3xl mb-2 block"></i>
                                    Tidak ada data hewan yang ditemukan
                                </td>
                            `;
                            tbody.appendChild(row);
                        }
                        
                        showLoading(false);
                        
                    } catch (fallbackError) {
                        console.error('Fallback query also failed:', fallbackError);
                        alert('Gagal memuat data hewan. Silakan coba lagi atau hubungi administrator.');
                        showLoading(false);
                    }
                }
            }
        }

        function createHewanRow(hewan, nomor) {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50 transition-colors duration-200';
            
            // Fix: Ensure sapiType is properly displayed for sapi
            const sapiName = hewan.jenis === 'sapi' ? (hewan.sapiType || hewan.namaSapi || '-') : '-';
            const pemilikList = hewan.pemilik && hewan.pemilik.length > 0 
                ? hewan.pemilik.map((nama, index) => `${index + 1}. ${nama}`).join('<br>')
                : '-';
            
            // Add status indicator for full cattle
            const isFullCattle = hewan.jenis === 'sapi' && hewan.pemilik && hewan.pemilik.length >= 7;
            const statusBadge = isFullCattle 
                ? '<span class="ml-2 inline-flex items-center px-1.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Penuh</span>'
                : hewan.jenis === 'sapi' && hewan.pemilik && hewan.pemilik.length > 0
                ? `<span class="ml-2 inline-flex items-center px-1.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">${hewan.pemilik.length}/7</span>`
                : '';
            
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 border-b border-r border-gray-200">${nomor}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 border-b border-r border-gray-200 capitalize">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${hewan.jenis === 'sapi' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'}">
                        <i class="fas ${hewan.jenis === 'sapi' ? 'fa-cow' : 'fa-sheep'} mr-1"></i>
                        ${hewan.jenis}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 border-b border-r border-gray-200 font-medium">${sapiName}${statusBadge}</td>
                <td class="px-6 py-4 text-sm text-gray-900 border-b border-r border-gray-200" style="line-height: 1.4;">${pemilikList}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 border-b border-r border-gray-200">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                        ${hewan.tahun}
                    </span>
                </td>
                <td class="admin-only ${currentUser ? '' : 'hidden'} px-6 py-4 whitespace-nowrap text-sm font-medium border-b border-gray-200 text-center">
                    <button onclick="editHewan('${hewan.id}')" class="text-indigo-600 hover:text-indigo-900 mr-3 px-2 py-1 rounded hover:bg-indigo-50">
                        <i class="fas fa-edit mr-1"></i>Edit
                    </button>
                    <button onclick="deleteHewan('${hewan.id}')" class="text-red-600 hover:text-red-900 px-2 py-1 rounded hover:bg-red-50">
                        <i class="fas fa-trash mr-1"></i>Hapus
                    </button>
                </td>
            `;
            return row;
        }

        async function loadMustahikData() {
            const tbody = document.getElementById('mustahikTable');
            tbody.innerHTML = '';

            if (isDemo) {
                let filteredData = [...demoData.mustahik];
                
                // Apply year filter
                const yearFilter = document.getElementById('filterMustahikTahun').value;
                if (yearFilter) {
                    filteredData = filteredData.filter(m => m.tahun === yearFilter);
                }
                
                // Apply RT filter
                const rtFilter = document.getElementById('filterMustahikRT').value;
                if (rtFilter) {
                    filteredData = filteredData.filter(m => m.rt === rtFilter);
                }
                
                // Apply search filter
                const searchTerm = document.getElementById('searchMustahik').value.toLowerCase();
                if (searchTerm) {
                    filteredData = filteredData.filter(m => 
                        m.nama.toLowerCase().includes(searchTerm)
                    );
                }
                
                // Sort by year (newest first) then by RT then by name
                filteredData.sort((a, b) => {
                    if (a.tahun !== b.tahun) {
                        return b.tahun.localeCompare(a.tahun);
                    }
                    if (a.rt !== b.rt) {
                        return a.rt.localeCompare(b.rt);
                    }
                    return a.nama.localeCompare(b.nama);
                });
                
                filteredData.forEach((mustahik, index) => {
                    const row = createMustahikRow(mustahik, index + 1);
                    tbody.appendChild(row);
                });
                
                // Show no data message if empty
                if (filteredData.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td colspan="5" class="px-6 py-8 text-center text-gray-500 border border-gray-300">
                            <i class="fas fa-search text-3xl mb-2 block"></i>
                            Tidak ada data mustahik yang ditemukan
                        </td>
                    `;
                    tbody.appendChild(row);
                }
            } else {
                try {
                    showLoading(true);
                    
                    // Simplified query strategy to avoid composite index requirements
                    let query = db.collection('mustahik');
                    
                    // Apply filters one at a time to avoid complex composite indexes
                    const yearFilter = document.getElementById('filterMustahikTahun').value;
                    const rtFilter = document.getElementById('filterMustahikRT').value;
                    
                    if (yearFilter && rtFilter) {
                        // If both filters are applied, use both in query
                        query = query.where('tahun', '==', yearFilter).where('rt', '==', rtFilter);
                    } else if (yearFilter) {
                        query = query.where('tahun', '==', yearFilter);
                    } else if (rtFilter) {
                        query = query.where('rt', '==', rtFilter);
                    }
                    
                    // Simple ordering by one field only to avoid composite index requirement
                    query = query.orderBy('tahun', 'desc');
                    
                    const snapshot = await query.get();
                    let mustahikData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // Apply remaining filters client-side
                    if (yearFilter && rtFilter) {
                        // Both already applied in query
                    } else if (yearFilter && !rtFilter) {
                        // Year already applied, filter RT client-side if needed
                        const clientRtFilter = document.getElementById('filterMustahikRT').value;
                        if (clientRtFilter) {
                            mustahikData = mustahikData.filter(m => m.rt === clientRtFilter);
                        }
                    } else if (!yearFilter && rtFilter) {
                        // RT already applied, filter year client-side if needed
                        const clientYearFilter = document.getElementById('filterMustahikTahun').value;
                        if (clientYearFilter) {
                            mustahikData = mustahikData.filter(m => m.tahun === clientYearFilter);
                        }
                    }
                    
                    // Apply search filter (client-side)
                    const searchTerm = document.getElementById('searchMustahik').value.toLowerCase();
                    if (searchTerm) {
                        mustahikData = mustahikData.filter(m => 
                            m.nama.toLowerCase().includes(searchTerm)
                        );
                    }
                    
                    // Sort client-side to avoid composite index requirement
                    mustahikData.sort((a, b) => {
                        if (a.tahun !== b.tahun) {
                            return b.tahun.localeCompare(a.tahun);
                        }
                        if (a.rt !== b.rt) {
                            return a.rt.localeCompare(b.rt);
                        }
                        return a.nama.localeCompare(b.nama);
                    });
                    
                    mustahikData.forEach((mustahik, index) => {
                        const row = createMustahikRow(mustahik, index + 1);
                        tbody.appendChild(row);
                    });
                    
                    // Show no data message if empty
                    if (mustahikData.length === 0) {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td colspan="5" class="px-6 py-8 text-center text-gray-500 border border-gray-300">
                                <i class="fas fa-search text-3xl mb-2 block"></i>
                                Tidak ada data mustahik yang ditemukan
                            </td>
                        `;
                        tbody.appendChild(row);
                    }
                    
                    showLoading(false);
                    
                } catch (error) {
                    console.error('Error loading mustahik data:', error);
                    
                    // Fallback: simple query without complex filtering
                    try {
                        let fallbackQuery = db.collection('mustahik');
                        const fallbackSnapshot = await fallbackQuery.get();
                        let fallbackData = fallbackSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        
                        // Apply all filters client-side
                        const yearFilter = document.getElementById('filterMustahikTahun').value;
                        const rtFilter = document.getElementById('filterMustahikRT').value;
                        const searchTerm = document.getElementById('searchMustahik').value.toLowerCase();
                        
                        if (yearFilter) {
                            fallbackData = fallbackData.filter(m => m.tahun === yearFilter);
                        }
                        
                        if (rtFilter) {
                            fallbackData = fallbackData.filter(m => m.rt === rtFilter);
                        }
                        
                        if (searchTerm) {
                            fallbackData = fallbackData.filter(m => 
                                m.nama.toLowerCase().includes(searchTerm)
                            );
                        }
                        
                        // Sort client-side
                        fallbackData.sort((a, b) => {
                            if (a.tahun !== b.tahun) {
                                return b.tahun.localeCompare(a.tahun);
                            }
                            if (a.rt !== b.rt) {
                                return a.rt.localeCompare(b.rt);
                            }
                            return a.nama.localeCompare(b.nama);
                        });
                        
                        fallbackData.forEach((mustahik, index) => {
                            const row = createMustahikRow(mustahik, index + 1);
                            tbody.appendChild(row);
                        });
                        
                        if (fallbackData.length === 0) {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td colspan="5" class="px-6 py-8 text-center text-gray-500 border border-gray-300">
                                    <i class="fas fa-search text-3xl mb-2 block"></i>
                                    Tidak ada data mustahik yang ditemukan
                                </td>
                            `;
                            tbody.appendChild(row);
                        }
                        
                        showLoading(false);
                        
                    } catch (fallbackError) {
                        console.error('Fallback query also failed:', fallbackError);
                        alert('Gagal memuat data mustahik. Silakan coba lagi atau hubungi administrator.');
                        showLoading(false);
                    }
                }
            }
        }

        function createMustahikRow(mustahik, nomor) {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50 transition-colors duration-200';
            row.innerHTML = `
                <td class="px-4 py-3 text-center text-sm font-medium text-gray-900 border border-gray-300 bg-white">${nomor}</td>
                <td class="px-6 py-3 text-left text-sm text-gray-900 border border-gray-300 bg-white">${mustahik.nama}</td>
                <td class="px-4 py-3 text-center text-sm text-gray-900 border border-gray-300 bg-white">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                        ${mustahik.rt}
                    </span>
                </td>
                <td class="px-4 py-3 text-center text-sm text-gray-900 border border-gray-300 bg-white">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                        ${mustahik.tahun}
                    </span>
                </td>
                <td class="admin-only ${currentUser ? '' : 'hidden'} px-6 py-3 text-center text-sm font-medium border border-gray-300 bg-white">
                    <button onclick="editMustahik('${mustahik.id}')" class="text-indigo-600 hover:text-indigo-900 mr-3 px-2 py-1 rounded hover:bg-indigo-50">
                        <i class="fas fa-edit mr-1"></i>Edit
                    </button>
                    <button onclick="deleteMustahik('${mustahik.id}')" class="text-red-600 hover:text-red-900 px-2 py-1 rounded hover:bg-red-50">
                        <i class="fas fa-trash mr-1"></i>Hapus
                    </button>
                </td>
            `;
            return row;
        }

        async function loadGuruData() {
            const tbody = document.getElementById('guruTable');
            tbody.innerHTML = '';

            if (isDemo) {
                let filteredData = [...demoData.guru];
                
                // Apply year filter
                const yearFilter = document.getElementById('filterGuruTahun').value;
                if (yearFilter) {
                    filteredData = filteredData.filter(g => g.tahun === yearFilter);
                }
                
                // Apply kategori filter
                const kategoriFilter = document.getElementById('filterGuruKategori').value;
                if (kategoriFilter) {
                    filteredData = filteredData.filter(g => g.kategori === kategoriFilter);
                }
                
                // Apply search filter
                const searchTerm = document.getElementById('searchGuru').value.toLowerCase();
                if (searchTerm) {
                    filteredData = filteredData.filter(g => 
                        g.nama.toLowerCase().includes(searchTerm)
                    );
                }
                
                // Sort by year (newest first) then by kategori then by name
                filteredData.sort((a, b) => {
                    if (a.tahun !== b.tahun) {
                        return b.tahun.localeCompare(a.tahun);
                    }
                    if (a.kategori !== b.kategori) {
                        return a.kategori.localeCompare(b.kategori);
                    }
                    return a.nama.localeCompare(b.nama);
                });
                
                filteredData.forEach((guru, index) => {
                    const row = createGuruRow(guru, index + 1);
                    tbody.appendChild(row);
                });
                
                // Show no data message if empty
                if (filteredData.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td colspan="5" class="px-6 py-8 text-center text-gray-500 border border-gray-300">
                            <i class="fas fa-search text-3xl mb-2 block"></i>
                            Tidak ada data guru/sepuh yang ditemukan
                        </td>
                    `;
                    tbody.appendChild(row);
                }
            } else {
                try {
                    showLoading(true);
                    
                    // Simplified query strategy to avoid composite index requirements
                    let query = db.collection('guru');
                    
                    // Apply filters one at a time to avoid complex composite indexes
                    const yearFilter = document.getElementById('filterGuruTahun').value;
                    const kategoriFilter = document.getElementById('filterGuruKategori').value;
                    
                    if (yearFilter && kategoriFilter) {
                        // If both filters are applied, use both in query
                        query = query.where('tahun', '==', yearFilter).where('kategori', '==', kategoriFilter);
                    } else if (yearFilter) {
                        query = query.where('tahun', '==', yearFilter);
                    } else if (kategoriFilter) {
                        query = query.where('kategori', '==', kategoriFilter);
                    }
                    
                    // Simple ordering by one field only to avoid composite index requirement
                    query = query.orderBy('tahun', 'desc');
                    
                    const snapshot = await query.get();
                    let guruData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // Apply remaining filters client-side
                    if (yearFilter && kategoriFilter) {
                        // Both already applied in query
                    } else if (yearFilter && !kategoriFilter) {
                        // Year already applied, filter kategori client-side if needed
                        const clientKategoriFilter = document.getElementById('filterGuruKategori').value;
                        if (clientKategoriFilter) {
                            guruData = guruData.filter(g => g.kategori === clientKategoriFilter);
                        }
                    } else if (!yearFilter && kategoriFilter) {
                        // Kategori already applied, filter year client-side if needed
                        const clientYearFilter = document.getElementById('filterGuruTahun').value;
                        if (clientYearFilter) {
                            guruData = guruData.filter(g => g.tahun === clientYearFilter);
                        }
                    }
                    
                    // Apply search filter (client-side)
                    const searchTerm = document.getElementById('searchGuru').value.toLowerCase();
                    if (searchTerm) {
                        guruData = guruData.filter(g => 
                            g.nama.toLowerCase().includes(searchTerm)
                        );
                    }
                    
                    // Sort client-side to avoid composite index requirement
                    guruData.sort((a, b) => {
                        if (a.tahun !== b.tahun) {
                            return b.tahun.localeCompare(a.tahun);
                        }
                        if (a.kategori !== b.kategori) {
                            return a.kategori.localeCompare(b.kategori);
                        }
                        return a.nama.localeCompare(b.nama);
                    });
                    
                    guruData.forEach((guru, index) => {
                        const row = createGuruRow(guru, index + 1);
                        tbody.appendChild(row);
                    });
                    
                    // Show no data message if empty
                    if (guruData.length === 0) {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td colspan="5" class="px-6 py-8 text-center text-gray-500 border border-gray-300">
                                <i class="fas fa-search text-3xl mb-2 block"></i>
                                Tidak ada data guru/sepuh yang ditemukan
                            </td>
                        `;
                        tbody.appendChild(row);
                    }
                    
                    showLoading(false);
                    
                } catch (error) {
                    console.error('Error loading guru data:', error);
                    
                    // Fallback: simple query without complex filtering
                    try {
                        let fallbackQuery = db.collection('guru');
                        const fallbackSnapshot = await fallbackQuery.get();
                        let fallbackData = fallbackSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        
                        // Apply all filters client-side
                        const yearFilter = document.getElementById('filterGuruTahun').value;
                        const kategoriFilter = document.getElementById('filterGuruKategori').value;
                        const searchTerm = document.getElementById('searchGuru').value.toLowerCase();
                        
                        if (yearFilter) {
                            fallbackData = fallbackData.filter(g => g.tahun === yearFilter);
                        }
                        
                        if (kategoriFilter) {
                            fallbackData = fallbackData.filter(g => g.kategori === kategoriFilter);
                        }
                        
                        if (searchTerm) {
                            fallbackData = fallbackData.filter(g => 
                                g.nama.toLowerCase().includes(searchTerm)
                            );
                        }
                        
                        // Sort client-side
                        fallbackData.sort((a, b) => {
                            if (a.tahun !== b.tahun) {
                                return b.tahun.localeCompare(a.tahun);
                            }
                            if (a.kategori !== b.kategori) {
                                return a.kategori.localeCompare(b.kategori);
                            }
                            return a.nama.localeCompare(b.nama);
                        });
                        
                        fallbackData.forEach((guru, index) => {
                            const row = createGuruRow(guru, index + 1);
                            tbody.appendChild(row);
                        });
                        
                        if (fallbackData.length === 0) {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td colspan="5" class="px-6 py-8 text-center text-gray-500 border border-gray-300">
                                    <i class="fas fa-search text-3xl mb-2 block"></i>
                                    Tidak ada data guru/sepuh yang ditemukan
                                </td>
                            `;
                            tbody.appendChild(row);
                        }
                        
                        showLoading(false);
                        
                    } catch (fallbackError) {
                        console.error('Fallback query also failed:', fallbackError);
                        alert('Gagal memuat data guru/sepuh. Silakan coba lagi atau hubungi administrator.');
                        showLoading(false);
                    }
                }
            }
        }

        function createGuruRow(guru, nomor) {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50 transition-colors duration-200';
            row.innerHTML = `
                <td class="px-4 py-3 text-center text-sm font-medium text-gray-900 border border-gray-300 bg-white">${nomor}</td>
                <td class="px-6 py-3 text-left text-sm text-gray-900 border border-gray-300 bg-white">${guru.nama}</td>
                <td class="px-4 py-3 text-center text-sm text-gray-900 border border-gray-300 bg-white">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800 capitalize">
                        ${guru.kategori}
                    </span>
                </td>
                <td class="px-4 py-3 text-center text-sm text-gray-900 border border-gray-300 bg-white">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                        ${guru.tahun}
                    </span>
                </td>
                <td class="admin-only ${currentUser ? '' : 'hidden'} px-6 py-3 text-center text-sm font-medium border border-gray-300 bg-white">
                    <button onclick="editGuru('${guru.id}')" class="text-indigo-600 hover:text-indigo-900 mr-3 px-2 py-1 rounded hover:bg-indigo-50">
                        <i class="fas fa-edit mr-1"></i>Edit
                    </button>
                    <button onclick="deleteGuru('${guru.id}')" class="text-red-600 hover:text-red-900 px-2 py-1 rounded hover:bg-red-50">
                        <i class="fas fa-trash mr-1"></i>Hapus
                    </button>
                </td>
            `;
            return row;
        }

        async function loadGaleriData() {
            const grid = document.getElementById('galeriGrid');
            const noPhotosMessage = document.getElementById('noPhotosMessage');
            const totalFotoElement = document.getElementById('totalFotoGaleri');
            grid.innerHTML = '';

            if (isDemo) {
                let filteredData = [...demoData.galeri];
                
                // Apply year filter
                const yearFilter = document.getElementById('filterGaleriTahun').value;
                if (yearFilter) {
                    filteredData = filteredData.filter(f => f.tahun === yearFilter);
                }
                
                // Apply search filter
                const searchTerm = document.getElementById('searchGaleri').value.toLowerCase();
                if (searchTerm) {
                    filteredData = filteredData.filter(f => 
                        f.keterangan.toLowerCase().includes(searchTerm) ||
                        f.kategori.toLowerCase().includes(searchTerm)
                    );
                }
                
                // Sort by year (newest first) then by category
                filteredData.sort((a, b) => {
                    if (a.tahun !== b.tahun) {
                        return b.tahun.localeCompare(a.tahun);
                    }
                    return a.kategori.localeCompare(b.kategori);
                });
                
                // Update total count
                totalFotoElement.textContent = filteredData.length;
                
                if (filteredData.length === 0) {
                    noPhotosMessage.classList.remove('hidden');
                    grid.classList.add('hidden');
                } else {
                    noPhotosMessage.classList.add('hidden');
                    grid.classList.remove('hidden');
                    
                    filteredData.forEach(foto => {
                        const card = createFotoCard(foto);
                        grid.appendChild(card);
                    });
                }
            } else {
                try {
                    showLoading(true);
                    
                    // Simplified query to avoid composite index requirement
                    let query = db.collection('galeri');
                    
                    // Apply year filter if specified
                    const yearFilter = document.getElementById('filterGaleriTahun').value;
                    if (yearFilter) {
                        query = query.where('tahun', '==', yearFilter);
                    }
                    
                    // Simple ordering by one field only to avoid composite index requirement
                    query = query.orderBy('tahun', 'desc');
                    
                    const snapshot = await query.get();
                    let galeriData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // Apply search filter (client-side)
                    const searchTerm = document.getElementById('searchGaleri').value.toLowerCase();
                    if (searchTerm) {
                        galeriData = galeriData.filter(f => 
                            f.keterangan.toLowerCase().includes(searchTerm) ||
                            f.kategori.toLowerCase().includes(searchTerm)
                        );
                    }
                    
                    // Sort by category client-side to avoid composite index requirement
                    galeriData.sort((a, b) => {
                        if (a.tahun !== b.tahun) {
                            return b.tahun.localeCompare(a.tahun);
                        }
                        return a.kategori.localeCompare(b.kategori);
                    });
                    
                    // Update total count
                    totalFotoElement.textContent = galeriData.length;
                    
                    if (galeriData.length === 0) {
                        noPhotosMessage.classList.remove('hidden');
                        grid.classList.add('hidden');
                    } else {
                        noPhotosMessage.classList.add('hidden');
                        grid.classList.remove('hidden');
                        
                        galeriData.forEach(foto => {
                            const card = createFotoCard(foto);
                            grid.appendChild(card);
                        });
                    }
                    
                    showLoading(false);
                    
                } catch (error) {
                    console.error('Error loading galeri data:', error);
                    
                    // Fallback: simple query without any ordering
                    try {
                        let fallbackQuery = db.collection('galeri');
                        
                        // Apply year filter if specified
                        const yearFilter = document.getElementById('filterGaleriTahun').value;
                        if (yearFilter) {
                            fallbackQuery = fallbackQuery.where('tahun', '==', yearFilter);
                        }
                        
                        const fallbackSnapshot = await fallbackQuery.get();
                        let fallbackData = fallbackSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        
                        // Apply search filter client-side
                        const searchTerm = document.getElementById('searchGaleri').value.toLowerCase();
                        if (searchTerm) {
                            fallbackData = fallbackData.filter(f => 
                                f.keterangan.toLowerCase().includes(searchTerm) ||
                                f.kategori.toLowerCase().includes(searchTerm)
                            );
                        }
                        
                        // Sort client-side
                        fallbackData.sort((a, b) => {
                            if (a.tahun !== b.tahun) {
                                return b.tahun.localeCompare(a.tahun);
                            }
                            return a.kategori.localeCompare(b.kategori);
                        });
                        
                        // Update total count
                        totalFotoElement.textContent = fallbackData.length;
                        
                        if (fallbackData.length === 0) {
                            noPhotosMessage.classList.remove('hidden');
                            grid.classList.add('hidden');
                        } else {
                            noPhotosMessage.classList.add('hidden');
                            grid.classList.remove('hidden');
                            
                            fallbackData.forEach(foto => {
                                const card = createFotoCard(foto);
                                grid.appendChild(card);
                            });
                        }
                        
                        showLoading(false);
                        
                    } catch (fallbackError) {
                        console.error('Fallback query also failed:', fallbackError);
                        alert('Gagal memuat data galeri. Silakan coba lagi atau hubungi administrator.');
                        showLoading(false);
                    }
                }
            }
        }

        function createFotoCard(foto) {
            const div = document.createElement('div');
            div.className = 'bg-white rounded-lg shadow-md overflow-hidden cursor-pointer hover:shadow-lg transition-shadow duration-200 group';
            
            // Get category color
            const categoryColors = {
                'persiapan': 'bg-yellow-100 text-yellow-800',
                'penyembelihan': 'bg-red-100 text-red-800',
                'pengolahan': 'bg-orange-100 text-orange-800',
                'pembagian': 'bg-green-100 text-green-800',
                'panitia': 'bg-blue-100 text-blue-800',
                'lainnya': 'bg-gray-100 text-gray-800'
            };
            
            const categoryColor = categoryColors[foto.kategori] || 'bg-gray-100 text-gray-800';
            
            div.innerHTML = `
                <div class="relative">
                    <img src="${foto.url}" alt="${foto.keterangan}" class="w-full h-24 sm:h-28 object-cover group-hover:scale-105 transition-transform duration-200" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjE1MCIgdmlld0JveD0iMCAwIDE1MCAxNTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxNTAiIGhlaWdodD0iMTUwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik03NSA0NUMzNy41IDQ1IDQ1IDc1IDc1IDc1QzEwNSA3NSAxMTIuNSA0NSA3NSA0NVoiIGZpbGw9IiM5Q0EzQUYiLz4KPHN2ZyBpZD0iY2FtZXJhIiB3aWR0aD0iMzAiIGhlaWdodD0iMzAiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4PSI2MCIgeT0iNjAiPgo8cGF0aCBkPSJNMTIgMTVDMTMuNjU2OSAxNSAxNSAxMy42NTY5IDE1IDEyQzE1IDEwLjM0MzEgMTMuNjU2OSA5IDEyIDlDMTAuMzQzMSA5IDkgMTAuMzQzMSA5IDEyQzkgMTMuNjU2OSAxMC4zNDMxIDE1IDEyIDE1WiIgZmlsbD0iIzlDQTNBRiIvPgo8cGF0aCBkPSJNMyA3VjE3QzMgMTguMTA0NiAzLjg5NTQzIDE5IDUgMTlIMTlDMjAuMTA0NiAxOSAyMSAxOC4xMDQ2IDIxIDE3VjdDMjEgNS44OTU0MyAyMC4xMDQ2IDUgMTkgNUgxNkwxNSAzSDlMOCA1SDVDNC44OTU0MyA1IDQgNS44OTU0MyA0IDdIMTlWMTdINVY3SDNaIiBmaWxsPSIjOUNBM0FGIi8+Cjwvc3ZnPgo8L3N2Zz4='; this.alt='Foto tidak dapat dimuat';">
                    <div class="absolute top-1 right-1 flex space-x-1">
                        <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-black bg-opacity-70 text-white">
                            ${foto.tahun}
                        </span>
                        <button onclick="deleteFoto('${foto.id}')" class="admin-only ${currentUser ? '' : 'hidden'} bg-red-600 hover:bg-red-700 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="absolute bottom-1 left-1">
                        <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium ${categoryColor}">
                            ${foto.kategori}
                        </span>
                    </div>
                </div>
                <div class="p-2">
                    <p class="text-xs text-gray-700 line-clamp-2 leading-tight">${foto.keterangan}</p>
                </div>
            `;
            
            // Add click event to view photo
            div.addEventListener('click', () => viewPhoto(foto));
            
            return div;
        }

        async function loadLaporanData() {
            if (isDemo) {
                const yearFilter = document.getElementById('filterLaporanTahun').value;
                const jenisFilter = document.getElementById('filterLaporanJenis').value;
                
                // Filter data by year
                let filteredPanitia = yearFilter ? demoData.panitia.filter(p => p.tahun === yearFilter) : demoData.panitia;
                let filteredHewan = yearFilter ? demoData.hewan.filter(h => h.tahun === yearFilter) : demoData.hewan;
                let filteredMustahik = yearFilter ? demoData.mustahik.filter(m => m.tahun === yearFilter) : demoData.mustahik;
                let filteredGuru = yearFilter ? demoData.guru.filter(g => g.tahun === yearFilter) : demoData.guru;
                
                // Filter hewan by jenis if specified (for animal-specific filters)
                if (jenisFilter === 'sapi' || jenisFilter === 'kambing') {
                    filteredHewan = filteredHewan.filter(h => h.jenis === jenisFilter);
                }
                
                // Calculate statistics
                const totalSapi = filteredHewan.filter(h => h.jenis === 'sapi').length;
                const totalKambing = filteredHewan.filter(h => h.jenis === 'kambing').length;
                const totalPequrban = filteredHewan.reduce((total, hewan) => total + hewan.pemilik.length, 0);
                
                // Jika tidak ada filter, pakai tahun saat ini
const tahunMasehi = new Date().getFullYear();
const tahunHijriah = tahunMasehi - 579; // perkiraan konversi Hijriah

let periode = yearFilter && yearFilter !== "all"
  ? `Tahun ${yearFilter}`
  : `${tahunHijriah}H / ${tahunMasehi}`;

                let reportTitle = 'LAPORAN KEGIATAN QURBAN';
                
                if (jenisFilter) {
                    switch(jenisFilter) {
                        case 'panitia':
                            reportTitle = 'LAPORAN DATA PANITIA';
                            periode += ' - Data Panitia';
                            break;
                        case 'hewan':
                            reportTitle = 'LAPORAN DATA HEWAN QURBAN';
                            periode += ' - Data Hewan';
                            break;
                        case 'mustahik':
                            reportTitle = 'LAPORAN DATA MUSTAHIK';
                            periode += ' - Data Mustahik';
                            break;
                        case 'pequrban':
                            reportTitle = 'LAPORAN DATA PEQURBAN';
                            periode += ' - Data Pequrban';
                            break;
                        case 'guru':
                            reportTitle = 'LAPORAN DATA GURU & SEPUH';
                            periode += ' - Data Guru & Sepuh';
                            break;
                        case 'sapi':
                            reportTitle = 'LAPORAN HEWAN SAPI';
                            periode += ' - Sapi Saja';
                            break;
                        case 'kambing':
                            reportTitle = 'LAPORAN HEWAN KAMBING';
                            periode += ' - Kambing Saja';
                            break;
                    }
                }
                
                document.querySelector('.bg-gradient-to-r h2').textContent = reportTitle;
                document.getElementById('laporanPeriode').textContent = `Periode: ${periode}`;
                document.getElementById('tanggalCetak').textContent = new Date().toLocaleDateString('id-ID', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                // Update summary cards
                document.getElementById('laporanTotalPanitia').textContent = filteredPanitia.length;
                document.getElementById('laporanTotalHewan').textContent = filteredHewan.length;
                document.getElementById('laporanTotalPequrban').textContent = totalPequrban;
                document.getElementById('laporanTotalSapi').textContent = totalSapi;
                document.getElementById('laporanTotalKambing').textContent = totalKambing;
                document.getElementById('laporanTotalMustahik').textContent = filteredMustahik.length;
                document.getElementById('laporanTotalGuru').textContent = filteredGuru.length;
                
                // Show/hide sections based on filter
                showReportSections(jenisFilter);
                
                // Load detailed tables
                loadLaporanHewanTable(filteredHewan);
                loadLaporanMustahikTable(filteredMustahik);
                loadLaporanPanitiaTable(filteredPanitia);
                loadLaporanPequrbanTable(filteredHewan);
                loadLaporanGuruTable(filteredGuru);
            } else {
                try {
                    showLoading(true);
                    
                    const yearFilter = document.getElementById('filterLaporanTahun').value;
                    const jenisFilter = document.getElementById('filterLaporanJenis').value;
                    
                    // Build queries for each collection
                    let panitiaQuery = db.collection('panitia');
                    let hewanQuery = db.collection('hewan');
                    let mustahikQuery = db.collection('mustahik');
                    let guruQuery = db.collection('guru');
                    
                    // Apply year filter if selected
                    if (yearFilter) {
                        panitiaQuery = panitiaQuery.where('tahun', '==', yearFilter);
                        hewanQuery = hewanQuery.where('tahun', '==', yearFilter);
                        mustahikQuery = mustahikQuery.where('tahun', '==', yearFilter);
                        guruQuery = guruQuery.where('tahun', '==', yearFilter);
                    }
                    
                    // Apply jenis filter for hewan if specified
                    if (jenisFilter === 'sapi' || jenisFilter === 'kambing') {
                        hewanQuery = hewanQuery.where('jenis', '==', jenisFilter);
                    }
                    
                    // Execute queries
                    const [panitiaSnapshot, hewanSnapshot, mustahikSnapshot, guruSnapshot] = await Promise.all([
                        panitiaQuery.get(),
                        hewanQuery.get(),
                        mustahikQuery.get(),
                        guruQuery.get()
                    ]);
                    
                    // Convert to arrays
                    const filteredPanitia = panitiaSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    const filteredHewan = hewanSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    const filteredMustahik = mustahikSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    const filteredGuru = guruSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // Calculate statistics
                    const totalSapi = filteredHewan.filter(h => h.jenis === 'sapi').length;
                    const totalKambing = filteredHewan.filter(h => h.jenis === 'kambing').length;
                    const totalPequrban = filteredHewan.reduce((total, hewan) => total + (hewan.pemilik ? hewan.pemilik.length : 0), 0);
                    
                    // Jika tidak ada filter, pakai tahun saat ini
const tahunMasehi = new Date().getFullYear();
const tahunHijriah = tahunMasehi - 579; // perkiraan konversi Hijriah

let periode = yearFilter && yearFilter !== "all"
  ? `Tahun ${yearFilter}`
  : `${tahunHijriah}H / ${tahunMasehi}`;

                    let reportTitle = 'LAPORAN KEGIATAN QURBAN';
                    
                    if (jenisFilter) {
                        switch(jenisFilter) {
                            case 'panitia':
                                reportTitle = 'LAPORAN DATA PANITIA';
                                periode += ' - Data Panitia';
                                break;
                            case 'hewan':
                                reportTitle = 'LAPORAN DATA HEWAN QURBAN';
                                periode += ' - Data Hewan';
                                break;
                            case 'mustahik':
                                reportTitle = 'LAPORAN DATA MUSTAHIK';
                                periode += ' - Data Mustahik';
                                break;
                            case 'pequrban':
                                reportTitle = 'LAPORAN DATA PEQURBAN';
                                periode += ' - Data Pequrban';
                                break;
                            case 'guru':
                                reportTitle = 'LAPORAN DATA GURU & SEPUH';
                                periode += ' - Data Guru & Sepuh';
                                break;
                            case 'sapi':
                                reportTitle = 'LAPORAN HEWAN SAPI';
                                periode += ' - Sapi Saja';
                                break;
                            case 'kambing':
                                reportTitle = 'LAPORAN HEWAN KAMBING';
                                periode += ' - Kambing Saja';
                                break;
                        }
                    }
                    
                    document.querySelector('.bg-gradient-to-r h2').textContent = reportTitle;
                    document.getElementById('laporanPeriode').textContent = `Periode: ${periode}`;
                    document.getElementById('tanggalCetak').textContent = new Date().toLocaleDateString('id-ID', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                    
                    // Update summary cards
                    document.getElementById('laporanTotalPanitia').textContent = filteredPanitia.length;
                    document.getElementById('laporanTotalHewan').textContent = filteredHewan.length;
                    document.getElementById('laporanTotalPequrban').textContent = totalPequrban;
                    document.getElementById('laporanTotalSapi').textContent = totalSapi;
                    document.getElementById('laporanTotalKambing').textContent = totalKambing;
                    document.getElementById('laporanTotalMustahik').textContent = filteredMustahik.length;
                    document.getElementById('laporanTotalGuru').textContent = filteredGuru.length;
                    
                    // Show/hide sections based on filter
                    showReportSections(jenisFilter);
                    
                    // Load detailed tables
                    loadLaporanHewanTable(filteredHewan);
                    loadLaporanMustahikTable(filteredMustahik);
                    loadLaporanPanitiaTable(filteredPanitia);
                    loadLaporanPequrbanTable(filteredHewan);
                    loadLaporanGuruTable(filteredGuru);
                    
                    showLoading(false);
                    
                } catch (error) {
                    console.error('Error loading laporan data:', error);
                    alert('Gagal memuat data laporan: ' + error.message);
                    showLoading(false);
                }
            }
        }
        
        function showReportSections(jenisFilter) {
            const sections = document.querySelectorAll('#laporan-tab .space-y-8 > div');
            
            if (!jenisFilter) {
                // Show all sections for complete report
                sections.forEach(section => section.style.display = 'block');
            } else {
                // Hide all sections first
                sections.forEach(section => section.style.display = 'none');
                
                // Show specific section based on filter
                switch(jenisFilter) {
                    case 'panitia':
                        sections[3]?.style.setProperty('display', 'block'); // Panitia table (index 3)
                        break;
                    case 'hewan':
                    case 'sapi':
                    case 'kambing':
                        sections[0]?.style.setProperty('display', 'block'); // Hewan table (index 0)
                        break;
                    case 'mustahik':
                        sections[1]?.style.setProperty('display', 'block'); // Mustahik table (index 1)
                        break;
                    case 'pequrban':
                        sections[2]?.style.setProperty('display', 'block'); // Pequrban table (index 2)
                        break;
                    case 'guru':
                        sections[4]?.style.setProperty('display', 'block'); // Guru table (index 4)
                        break;
                }
            }
        }

        function loadLaporanHewanTable(hewanData) {
            const tbody = document.getElementById('laporanHewanTable');
            tbody.innerHTML = '';
            
            hewanData.forEach((hewan, index) => {
                // Fix: Ensure sapiType is properly displayed in reports
                const sapiName = hewan.jenis === 'sapi' ? (hewan.sapiType || hewan.namaSapi || '-') : '-';
                const pemilikCount = hewan.pemilik && hewan.pemilik.length ? hewan.pemilik.length : 0;
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm border border-gray-300 text-center">${index + 1}</td>
                    <td class="px-4 py-3 text-sm border border-gray-300 capitalize">
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${hewan.jenis === 'sapi' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'}">
                            <i class="fas ${hewan.jenis === 'sapi' ? 'fa-cow' : 'fa-sheep'} mr-1"></i>
                            ${hewan.jenis}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-sm border border-gray-300 font-medium">${sapiName}</td>
                    <td class="px-4 py-3 text-sm border border-gray-300 text-center font-medium">${pemilikCount} orang</td>
                    <td class="px-4 py-3 text-sm border border-gray-300 text-center">
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                            ${hewan.tahun}
                        </span>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Add total row if there's data
            if (hewanData.length > 0) {
                const totalRow = document.createElement('tr');
                totalRow.className = 'bg-gray-100 font-semibold';
                totalRow.innerHTML = `
                    <td class="px-4 py-3 text-sm border border-gray-300 text-center font-bold" colspan="4">TOTAL HEWAN</td>
                    <td class="px-4 py-3 text-sm border border-gray-300 text-center font-bold text-blue-700">${hewanData.length} ekor</td>
                `;
                tbody.appendChild(totalRow);
            }
        }

        function loadLaporanMustahikTable(mustahikData) {
            const tbody = document.getElementById('laporanMustahikTable');
            tbody.innerHTML = '';
            
            // Group by RT
            const rtStats = {};
            mustahikData.forEach(m => {
                rtStats[m.rt] = (rtStats[m.rt] || 0) + 1;
            });
            
            const totalMustahik = mustahikData.length;
            
            Object.entries(rtStats).sort().forEach(([rt, count]) => {
                const percentage = totalMustahik > 0 ? ((count / totalMustahik) * 100).toFixed(1) : 0;
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm border border-gray-300">${rt}</td>
                    <td class="px-4 py-3 text-sm border border-gray-300 text-center font-medium">${count} mustahik</td>
                    <td class="px-4 py-3 text-sm border border-gray-300">${percentage}%</td>
                `;
                tbody.appendChild(row);
            });
        }

        function loadLaporanPanitiaTable(panitiaData) {
            const tbody = document.getElementById('laporanPanitiaTable');
            tbody.innerHTML = '';
            
            panitiaData.forEach((panitia, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm border border-gray-300">${index + 1}</td>
                    <td class="px-4 py-3 text-sm border border-gray-300">${panitia.nama}</td>
                    <td class="px-4 py-3 text-sm border border-gray-300">${panitia.jabatan}</td>
                    <td class="px-4 py-3 text-sm border border-gray-300">${panitia.hp}</td>
                    <td class="px-4 py-3 text-sm border border-gray-300 text-center">${panitia.tahun}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function loadLaporanPequrbanTable(hewanData) {
            const tbody = document.getElementById('laporanPequrbanTable');
            tbody.innerHTML = '';
            
            let counter = 1;
            
            // Create a comprehensive list of all pequrban (animal owners)
            const allPequrban = [];
            
            hewanData.forEach(hewan => {
                if (hewan.pemilik && hewan.pemilik.length > 0) {
                    hewan.pemilik.forEach(pemilik => {
                        const sapiName = hewan.jenis === 'sapi' ? (hewan.sapiType || hewan.namaSapi || '-') : '-';
                        
                        allPequrban.push({
                            nama: pemilik,
                            jenis: hewan.jenis,
                            sapiName: sapiName,
                            tahun: hewan.tahun
                        });
                    });
                }
            });
            
            // Sort pequrban by name for better organization
            allPequrban.sort((a, b) => {
                if (a.tahun !== b.tahun) {
                    return b.tahun.localeCompare(a.tahun); // Newest year first
                }
                if (a.jenis !== b.jenis) {
                    return a.jenis.localeCompare(b.jenis); // Sapi first, then kambing
                }
                return a.nama.localeCompare(b.nama); // Alphabetical by name
            });
            
            // Display all pequrban
            allPequrban.forEach(pequrban => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm border border-gray-300 text-center">${counter}</td>
                    <td class="px-4 py-3 text-sm border border-gray-300 font-medium">${pequrban.nama}</td>
                    <td class="px-4 py-3 text-sm border border-gray-300 text-center">
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${pequrban.jenis === 'sapi' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'}">
                            <i class="fas ${pequrban.jenis === 'sapi' ? 'fa-cow' : 'fa-sheep'} mr-1"></i>
                            ${pequrban.jenis}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-sm border border-gray-300 font-medium">${pequrban.sapiName}</td>
                    <td class="px-4 py-3 text-sm border border-gray-300 text-center">
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                            ${pequrban.tahun}
                        </span>
                    </td>
                `;
                tbody.appendChild(row);
                counter++;
            });
            
            // Add summary row showing breakdown by animal type
            if (allPequrban.length > 0) {
                const sapiOwners = allPequrban.filter(p => p.jenis === 'sapi').length;
                const kambingOwners = allPequrban.filter(p => p.jenis === 'kambing').length;
                
                const summaryRow = document.createElement('tr');
                summaryRow.className = 'bg-orange-50 border-t-2 border-orange-200';
                summaryRow.innerHTML = `
                    <td class="px-4 py-3 text-sm border border-gray-300 text-center font-bold" colspan="2">RINGKASAN PEQURBAN</td>
                    <td class="px-4 py-3 text-sm border border-gray-300 text-center font-medium">
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800 mr-1">
                            <i class="fas fa-cow mr-1"></i>Sapi: ${sapiOwners}
                        </span>
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                            <i class="fas fa-sheep mr-1"></i>Kambing: ${kambingOwners}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-sm border border-gray-300 text-center font-bold text-orange-700">TOTAL</td>
                    <td class="px-4 py-3 text-sm border border-gray-300 text-center font-bold text-orange-700">${allPequrban.length} orang</td>
                `;
                tbody.appendChild(summaryRow);
            }
            
            // Add empty state if no data
            if (allPequrban.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `
                    <td colspan="5" class="px-4 py-8 text-center text-gray-500 border border-gray-300">
                        <i class="fas fa-users text-3xl mb-2 block"></i>
                        Tidak ada data pequrban ditemukan
                    </td>
                `;
                tbody.appendChild(emptyRow);
            }
        }

        function loadLaporanGuruTable(guruData) {
            const tbody = document.getElementById('laporanGuruTable');
            tbody.innerHTML = '';
            
            guruData.forEach((guru, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm border border-gray-300">${index + 1}</td>
                    <td class="px-4 py-3 text-sm border border-gray-300">${guru.nama}</td>
                    <td class="px-4 py-3 text-sm border border-gray-300 text-center capitalize">${guru.kategori}</td>
                    <td class="px-4 py-3 text-sm border border-gray-300 text-center">${guru.tahun}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function openModal(modalId, data = null) {
            document.getElementById(modalId).classList.remove('hidden');
            
            if (!editMode.isEditing) {
                // Clear form for new entry
                clearForm(modalId);
            }
            // Form is already filled by edit functions when in edit mode
        }

        async function handlePanitiaSubmit(e) {
            e.preventDefault();
            const formData = {
                nama: document.getElementById('panitiaNama').value,
                jabatan: document.getElementById('panitiaJabatan').value,
                hp: document.getElementById('panitiaHP').value,
                tahun: document.getElementById('panitiaTahun').value
            };

            if (editMode.isEditing && editMode.type === 'panitia') {
                // Update existing data
                formData.updatedAt = new Date();
                formData.updatedBy = currentUser ? currentUser.email : 'demo';

                if (isDemo) {
                    const index = demoData.panitia.findIndex(p => p.id === editMode.id);
                    if (index !== -1) {
                        demoData.panitia[index] = { ...demoData.panitia[index], ...formData };
                        loadPanitiaData();
                        loadDashboardData();
                        alert('Data panitia berhasil diperbarui!');
                    }
                } else {
                    try {
                        showLoading(true);
                        await db.collection('panitia').doc(editMode.id).update(formData);
                        loadPanitiaData();
                        loadDashboardData();
                        showLoading(false);
                        alert('Data panitia berhasil diperbarui!');
                    } catch (error) {
                        console.error('Error updating panitia:', error);
                        alert('Gagal memperbarui data panitia: ' + error.message);
                        showLoading(false);
                    }
                }
            } else {
                // Add new data
                formData.createdAt = new Date();
                formData.createdBy = currentUser ? currentUser.email : 'demo';

                if (isDemo) {
                    const id = Date.now().toString();
                    demoData.panitia.push({ id, ...formData });
                    loadPanitiaData();
                    loadDashboardData();
                    alert('Data panitia berhasil disimpan!');
                } else {
                    try {
                        showLoading(true);
                        await db.collection('panitia').add(formData);
                        loadPanitiaData();
                        loadDashboardData();
                        showLoading(false);
                        alert('Data panitia berhasil disimpan!');
                    } catch (error) {
                        console.error('Error adding panitia:', error);
                        alert('Gagal menyimpan data panitia: ' + error.message);
                        showLoading(false);
                    }
                }
            }

            // Reset edit mode
            editMode = { isEditing: false, type: null, id: null };
            document.getElementById('panitiaModal').classList.add('hidden');
        }

        async function handleHewanSubmit(e) {
            e.preventDefault();
            const jenis = document.getElementById('hewanJenis').value;
            const tahun = document.getElementById('hewanTahun').value;
            const pemilikInputs = document.querySelectorAll('.pemilik-input');
            const pemilik = Array.from(pemilikInputs).map(input => input.value).filter(val => val.trim());

            const formData = { 
                jenis, 
                pemilik, 
                tahun
            };
            
            if (jenis === 'sapi') {
                formData.sapiType = document.getElementById('sapiType').value;
            }

            if (editMode.isEditing && editMode.type === 'hewan') {
                // Update existing data
                formData.updatedAt = new Date();
                formData.updatedBy = currentUser ? currentUser.email : 'demo';

                if (isDemo) {
                    const index = demoData.hewan.findIndex(h => h.id === editMode.id);
                    if (index !== -1) {
                        demoData.hewan[index] = { ...demoData.hewan[index], ...formData };
                        loadHewanData();
                        loadDashboardData();
                        alert('Data hewan berhasil diperbarui!');
                    }
                } else {
                    try {
                        showLoading(true);
                        await db.collection('hewan').doc(editMode.id).update(formData);
                        loadHewanData();
                        loadDashboardData();
                        showLoading(false);
                        alert('Data hewan berhasil diperbarui!');
                    } catch (error) {
                        console.error('Error updating hewan:', error);
                        alert('Gagal memperbarui data hewan: ' + error.message);
                        showLoading(false);
                    }
                }
            } else {
                // Add new data
                formData.createdAt = new Date();
                formData.createdBy = currentUser ? currentUser.email : 'demo';

                if (isDemo) {
                    const id = Date.now().toString();
                    demoData.hewan.push({ id, ...formData });
                    loadHewanData();
                    loadDashboardData();
                    alert('Data hewan berhasil disimpan!');
                } else {
                    try {
                        showLoading(true);
                        await db.collection('hewan').add(formData);
                        loadHewanData();
                        loadDashboardData();
                        showLoading(false);
                        alert('Data hewan berhasil disimpan!');
                    } catch (error) {
                        console.error('Error adding hewan:', error);
                        alert('Gagal menyimpan data hewan: ' + error.message);
                        showLoading(false);
                    }
                }
            }

            // Reset edit mode
            editMode = { isEditing: false, type: null, id: null };
            document.getElementById('hewanModal').classList.add('hidden');
        }

        async function handleMustahikSubmit(e) {
            e.preventDefault();
            const formData = {
                nama: document.getElementById('mustahikNama').value,
                rt: document.getElementById('mustahikRT').value,
                tahun: document.getElementById('mustahikTahun').value
            };

            if (editMode.isEditing && editMode.type === 'mustahik') {
                // Update existing data
                formData.updatedAt = new Date();
                formData.updatedBy = currentUser ? currentUser.email : 'demo';

                if (isDemo) {
                    const index = demoData.mustahik.findIndex(m => m.id === editMode.id);
                    if (index !== -1) {
                        demoData.mustahik[index] = { ...demoData.mustahik[index], ...formData };
                        loadMustahikData();
                        loadDashboardData();
                        alert('Data mustahik berhasil diperbarui!');
                    }
                } else {
                    try {
                        showLoading(true);
                        await db.collection('mustahik').doc(editMode.id).update(formData);
                        loadMustahikData();
                        loadDashboardData();
                        showLoading(false);
                        alert('Data mustahik berhasil diperbarui!');
                    } catch (error) {
                        console.error('Error updating mustahik:', error);
                        alert('Gagal memperbarui data mustahik: ' + error.message);
                        showLoading(false);
                    }
                }
            } else {
                // Add new data
                formData.createdAt = new Date();
                formData.createdBy = currentUser ? currentUser.email : 'demo';

                if (isDemo) {
                    const id = Date.now().toString();
                    demoData.mustahik.push({ id, ...formData });
                    loadMustahikData();
                    loadDashboardData();
                    alert('Data mustahik berhasil disimpan!');
                } else {
                    try {
                        showLoading(true);
                        await db.collection('mustahik').add(formData);
                        loadMustahikData();
                        loadDashboardData();
                        showLoading(false);
                        alert('Data mustahik berhasil disimpan!');
                    } catch (error) {
                        console.error('Error adding mustahik:', error);
                        alert('Gagal menyimpan data mustahik: ' + error.message);
                        showLoading(false);
                    }
                }
            }

            // Reset edit mode
            editMode = { isEditing: false, type: null, id: null };
            document.getElementById('mustahikModal').classList.add('hidden');
        }

        async function handleGuruSubmit(e) {
            e.preventDefault();
            const formData = {
                nama: document.getElementById('guruNama').value,
                kategori: document.getElementById('guruKategori').value,
                tahun: document.getElementById('guruTahun').value
            };

            if (editMode.isEditing && editMode.type === 'guru') {
                // Update existing data
                formData.updatedAt = new Date();
                formData.updatedBy = currentUser ? currentUser.email : 'demo';

                if (isDemo) {
                    const index = demoData.guru.findIndex(g => g.id === editMode.id);
                    if (index !== -1) {
                        demoData.guru[index] = { ...demoData.guru[index], ...formData };
                        loadGuruData();
                        loadDashboardData();
                        alert('Data guru/sepuh berhasil diperbarui!');
                    }
                } else {
                    try {
                        showLoading(true);
                        await db.collection('guru').doc(editMode.id).update(formData);
                        loadGuruData();
                        loadDashboardData();
                        showLoading(false);
                        alert('Data guru/sepuh berhasil diperbarui!');
                    } catch (error) {
                        console.error('Error updating guru:', error);
                        alert('Gagal memperbarui data guru/sepuh: ' + error.message);
                        showLoading(false);
                    }
                }
            } else {
                // Add new data
                formData.createdAt = new Date();
                formData.createdBy = currentUser ? currentUser.email : 'demo';

                if (isDemo) {
                    const id = Date.now().toString();
                    demoData.guru.push({ id, ...formData });
                    loadGuruData();
                    loadDashboardData();
                    alert('Data guru/sepuh berhasil disimpan!');
                } else {
                    try {
                        showLoading(true);
                        await db.collection('guru').add(formData);
                        loadGuruData();
                        loadDashboardData();
                        showLoading(false);
                        alert('Data guru/sepuh berhasil disimpan!');
                    } catch (error) {
                        console.error('Error adding guru:', error);
                        alert('Gagal menyimpan data guru/sepuh: ' + error.message);
                        showLoading(false);
                    }
                }
            }

            // Reset edit mode
            editMode = { isEditing: false, type: null, id: null };
            document.getElementById('guruModal').classList.add('hidden');
        }

        async function handleFotoSubmit(e) {
            e.preventDefault();
            const files = document.getElementById('fotoFile').files;
            const tahun = document.getElementById('fotoTahun').value;
            const kategori = document.getElementById('fotoKategori').value;
            const keterangan = document.getElementById('fotoKeterangan').value;

            // Validate files
            const maxSize = 5 * 1024 * 1024; // 5MB
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
            
            for (let file of files) {
                if (file.size > maxSize) {
                    alert(`File ${file.name} terlalu besar. Maksimal 5MB per foto.`);
                    return;
                }
                if (!allowedTypes.includes(file.type)) {
                    alert(`File ${file.name} format tidak didukung. Gunakan JPG, JPEG, PNG, atau GIF.`);
                    return;
                }
            }

            if (isDemo) {
                showLoading(true);
                
                // Simulate multiple file upload
                setTimeout(() => {
                    Array.from(files).forEach((file, index) => {
                        const id = (Date.now() + index).toString();
                        const colors = ['10b981', '3b82f6', '8b5cf6', 'f59e0b', 'ef4444', '06b6d4', '84cc16', 'f97316'];
                        const randomColor = colors[Math.floor(Math.random() * colors.length)];
                        const url = `https://via.placeholder.com/150x150/${randomColor}/ffffff?text=${encodeURIComponent(file.name.substring(0, 8))}`;
                        
                        const fotoData = {
                            id,
                            url,
                            keterangan: files.length > 1 ? `${keterangan} (${index + 1})` : keterangan,
                            kategori,
                            tahun,
                            createdAt: new Date(),
                            createdBy: currentUser ? currentUser.email : 'demo'
                        };
                        
                        demoData.galeri.push(fotoData);
                    });
                    
                    loadGaleriData();
                    loadDashboardData();
                    showLoading(false);
                    
                    // Show success message
                    alert(`Berhasil mengupload ${files.length} foto!`);
                }, 1500);
            } else {
                try {
                    showLoading(true);
                    
                    // Upload files to Firebase Storage and save metadata to Firestore
                    const uploadPromises = Array.from(files).map(async (file, index) => {
                        // Create unique filename
                        const timestamp = Date.now();
                        const filename = `galeri/${tahun}/${timestamp}_${index}_${file.name}`;
                        
                        // Upload to Firebase Storage
                        const storageRef = storage.ref().child(filename);
                        const uploadTask = await storageRef.put(file);
                        const downloadURL = await uploadTask.ref.getDownloadURL();
                        
                        // Save metadata to Firestore
                        const fotoData = {
                            url: downloadURL,
                            filename: filename,
                            keterangan: files.length > 1 ? `${keterangan} (${index + 1})` : keterangan,
                            kategori,
                            tahun,
                            createdAt: new Date(),
                            createdBy: currentUser.email
                        };
                        
                        return db.collection('galeri').add(fotoData);
                    });
                    
                    await Promise.all(uploadPromises);
                    
                    loadGaleriData();
                    loadDashboardData();
                    showLoading(false);
                    
                    alert(`Berhasil mengupload ${files.length} foto!`);
                    
                } catch (error) {
                    console.error('Error uploading photos:', error);
                    alert('Gagal mengupload foto: ' + error.message);
                    showLoading(false);
                }
            }

            document.getElementById('fotoModal').classList.add('hidden');
        }

        async function deleteFoto(id) {
            if (confirm('Yakin ingin menghapus foto ini?')) {
                if (isDemo) {
                    demoData.galeri = demoData.galeri.filter(f => f.id !== id);
                    loadGaleriData();
                    loadDashboardData();
                    alert('Foto berhasil dihapus!');
                } else {
                    try {
                        showLoading(true);
                        
                        // Get photo data first to delete from storage
                        const doc = await db.collection('galeri').doc(id).get();
                        if (doc.exists) {
                            const photoData = doc.data();
                            
                            // Delete from Firebase Storage if filename exists
                            if (photoData.filename) {
                                try {
                                    await storage.ref().child(photoData.filename).delete();
                                } catch (storageError) {
                                    console.warn('Could not delete file from storage:', storageError);
                                    // Continue with Firestore deletion even if storage deletion fails
                                }
                            }
                            
                            // Delete from Firestore
                            await db.collection('galeri').doc(id).delete();
                            
                            loadGaleriData();
                            loadDashboardData();
                            showLoading(false);
                            alert('Foto berhasil dihapus!');
                        } else {
                            showLoading(false);
                            alert('Foto tidak ditemukan!');
                        }
                    } catch (error) {
                        console.error('Error deleting photo:', error);
                        alert('Gagal menghapus foto: ' + error.message);
                        showLoading(false);
                    }
                }
            }
        }

        function addPemilikField() {
            const container = document.getElementById('pemilikList');
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'pemilik-input w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-emerald-500 mb-2';
            input.placeholder = `Nama pemilik ${container.children.length + 1}`;
            container.appendChild(input);
        }

        function updatePemilikFields() {
            const jenis = document.getElementById('hewanJenis').value;
            const container = document.getElementById('pemilikList');
            
            if (jenis === 'sapi') {
                // Sapi needs 7 owners
                while (container.children.length < 7) {
                    addPemilikField();
                }
                document.getElementById('addPemilik').style.display = container.children.length >= 7 ? 'none' : 'block';
            } else {
                // Kambing needs 1 owner
                while (container.children.length > 1) {
                    container.removeChild(container.lastChild);
                }
                document.getElementById('addPemilik').style.display = 'none';
            }
        }

        async function updateSapiOptions() {
            const jenis = document.getElementById('hewanJenis').value;
            const sapiContainer = document.getElementById('sapiTypeContainer');
            const sapiSelect = document.getElementById('sapiType');
            
            if (jenis === 'sapi') {
                sapiContainer.classList.remove('hidden');
                sapiSelect.required = true;
                
                // Generate sapi options and check availability
                sapiSelect.innerHTML = '<option value="">Pilih Sapi</option>';
                
                // Get current data to check availability
                let currentHewanData = [];
                if (isDemo) {
                    currentHewanData = demoData.hewan;
                } else {
                    try {
                        const snapshot = await db.collection('hewan').where('jenis', '==', 'sapi').get();
                        currentHewanData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    } catch (error) {
                        console.warn('Could not load current cattle data:', error);
                        currentHewanData = [];
                    }
                }
                
                for (let i = 1; i <= 15; i++) {
                    const sapiName = `Sapi ${i}`;
                    
                    // Check if this sapi is already full (7 owners)
                    const existingSapi = currentHewanData.find(h => h.sapiType === sapiName);
                    const currentOwnerCount = existingSapi ? (existingSapi.pemilik ? existingSapi.pemilik.length : 0) : 0;
                    const isOccupied = currentOwnerCount >= 7;
                    
                    const option = document.createElement('option');
                    option.value = sapiName;
                    
                    if (isOccupied) {
                        option.textContent = `${sapiName} (Penuh - ${currentOwnerCount}/7)`;
                        option.disabled = true;
                        option.style.color = '#9CA3AF';
                        option.style.fontStyle = 'italic';
                    } else if (currentOwnerCount > 0) {
                        option.textContent = `${sapiName} (${currentOwnerCount}/7 tersedia)`;
                    } else {
                        option.textContent = `${sapiName} (Kosong)`;
                    }
                    
                    sapiSelect.appendChild(option);
                }
            } else {
                sapiContainer.classList.add('hidden');
                sapiSelect.required = false;
            }
        }

        async function exportLaporan() {
            try {
                showLoading(true);
                
                const yearFilter = document.getElementById('filterLaporanTahun').value;
                const jenisFilter = document.getElementById('filterLaporanJenis').value;
                
                // Get current data based on filters
                let filteredPanitia, filteredHewan, filteredMustahik, filteredGuru;
                
                if (isDemo) {
                    filteredPanitia = yearFilter ? demoData.panitia.filter(p => p.tahun === yearFilter) : demoData.panitia;
                    filteredHewan = yearFilter ? demoData.hewan.filter(h => h.tahun === yearFilter) : demoData.hewan;
                    filteredMustahik = yearFilter ? demoData.mustahik.filter(m => m.tahun === yearFilter) : demoData.mustahik;
                    filteredGuru = yearFilter ? demoData.guru.filter(g => g.tahun === yearFilter) : demoData.guru;
                    
                    if (jenisFilter === 'sapi' || jenisFilter === 'kambing') {
                        filteredHewan = filteredHewan.filter(h => h.jenis === jenisFilter);
                    }
                } else {
                    // Build queries for each collection
                    let panitiaQuery = db.collection('panitia');
                    let hewanQuery = db.collection('hewan');
                    let mustahikQuery = db.collection('mustahik');
                    let guruQuery = db.collection('guru');
                    
                    // Apply year filter if selected
                    if (yearFilter) {
                        panitiaQuery = panitiaQuery.where('tahun', '==', yearFilter);
                        hewanQuery = hewanQuery.where('tahun', '==', yearFilter);
                        mustahikQuery = mustahikQuery.where('tahun', '==', yearFilter);
                        guruQuery = guruQuery.where('tahun', '==', yearFilter);
                    }
                    
                    // Apply jenis filter for hewan if specified
                    if (jenisFilter === 'sapi' || jenisFilter === 'kambing') {
                        hewanQuery = hewanQuery.where('jenis', '==', jenisFilter);
                    }
                    
                    // Execute queries
                    const [panitiaSnapshot, hewanSnapshot, mustahikSnapshot, guruSnapshot] = await Promise.all([
                        panitiaQuery.get(),
                        hewanQuery.get(),
                        mustahikQuery.get(),
                        guruQuery.get()
                    ]);
                    
                    // Convert to arrays
                    filteredPanitia = panitiaSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    filteredHewan = hewanSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    filteredMustahik = mustahikSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    filteredGuru = guruSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                }
                
                // Generate PDF
                await generatePDFReport({
                    panitia: filteredPanitia,
                    hewan: filteredHewan,
                    mustahik: filteredMustahik,
                    guru: filteredGuru,
                    yearFilter,
                    jenisFilter
                });
                
                showLoading(false);
                
            } catch (error) {
                console.error('Error exporting PDF:', error);
                alert('Gagal mengexport laporan PDF: ' + error.message);
                showLoading(false);
            }
        }

        async function generatePDFReport(data) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            
            // PDF Configuration
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const margin = 15;
            const contentWidth = pageWidth - (margin * 2);
            let currentY = margin;
            
            // Colors
            const primaryColor = [6, 95, 70]; // Emerald-800
            const secondaryColor = [16, 185, 129]; // Emerald-500
            const textColor = [31, 41, 55]; // Gray-800
            const lightGray = [243, 244, 246]; // Gray-100
            
            // Helper function to add new page if needed
            function checkPageBreak(requiredHeight) {
                if (currentY + requiredHeight > pageHeight - margin) {
                    doc.addPage();
                    currentY = margin;
                    return true;
                }
                return false;
            }
            
            // Header with Islamic decoration
            function addHeader() {
                // Background header
                doc.setFillColor(...primaryColor);
                doc.rect(0, 0, pageWidth, 45, 'F');
                
                // Islamic pattern (simple geometric)
                doc.setDrawColor(255, 255, 255);
                doc.setLineWidth(0.5);
                for (let i = 0; i < pageWidth; i += 10) {
                    doc.line(i, 35, i + 5, 40);
                    doc.line(i + 5, 35, i + 10, 40);
                }
                
                // Bismillah
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('بِسْمِ اللَّهِ الرَّحْمَنِ الرَّحِيم', pageWidth/2, 15, { align: 'center' });
                
                // Title
                doc.setFontSize(18);
                let reportTitle = 'LAPORAN KEGIATAN QURBAN';
                if (data.jenisFilter) {
                    switch(data.jenisFilter) {
                        case 'panitia': reportTitle = 'LAPORAN DATA PANITIA'; break;
                        case 'hewan': reportTitle = 'LAPORAN DATA HEWAN QURBAN'; break;
                        case 'mustahik': reportTitle = 'LAPORAN DATA MUSTAHIK'; break;
                        case 'pequrban': reportTitle = 'LAPORAN DATA PEQURBAN'; break;
                        case 'guru': reportTitle = 'LAPORAN DATA GURU & SEPUH'; break;
                        case 'sapi': reportTitle = 'LAPORAN HEWAN SAPI'; break;
                        case 'kambing': reportTitle = 'LAPORAN HEWAN KAMBING'; break;
                    }
                }
                doc.text(reportTitle, pageWidth/2, 25, { align: 'center' });
                
                // Subtitle
                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');
                doc.text('MASJID NURUL FALAH (MNF)', pageWidth/2, 32, { align: 'center' });
                
                currentY = 55;
            }
            
            // Footer
            function addFooter() {
                const footerY = pageHeight - 20;
                doc.setDrawColor(...lightGray);
                doc.line(margin, footerY - 5, pageWidth - margin, footerY - 5);
                
                doc.setTextColor(...textColor);
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                
                const pageNum = doc.internal.getCurrentPageInfo().pageNumber;
                const totalPages = doc.internal.getNumberOfPages();
                
                doc.text(`Halaman ${pageNum} dari ${totalPages}`, pageWidth - margin, footerY, { align: 'right' });
                doc.text('Sistem Manajemen Qurban MNF - Generated by Canva Code', margin, footerY);
                doc.text(`Dicetak: ${new Date().toLocaleDateString('id-ID', { 
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
                })}`, margin, footerY + 5);
            }
            
            // Add header to first page
            addHeader();
            
            // Report Info
            doc.setTextColor(...textColor);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            
            const periode = data.yearFilter ? `Tahun ${data.yearFilter}` : 'Tahun';
            const jenisLaporan = data.jenisFilter ? 
                (data.jenisFilter.charAt(0).toUpperCase() + data.jenisFilter.slice(1)) : 'Laporan Lengkap';
            
            doc.text(`Periode: ${periode}`, margin, currentY);
            doc.text(`Jenis Laporan: ${jenisLaporan}`, margin, currentY + 5);
            doc.text(`Tanggal Cetak: ${new Date().toLocaleDateString('id-ID')}`, margin, currentY + 10);
            
            currentY += 25;
            
            // Summary Statistics
            checkPageBreak(40);
            
            doc.setFillColor(...secondaryColor);
            doc.rect(margin, currentY, contentWidth, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('RINGKASAN DATA', margin + 5, currentY + 5.5);
            
            currentY += 15;
            doc.setTextColor(...textColor);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            
            // Calculate statistics
            const totalSapi = data.hewan.filter(h => h.jenis === 'sapi').length;
            const totalKambing = data.hewan.filter(h => h.jenis === 'kambing').length;
            const totalPequrban = data.hewan.reduce((total, hewan) => total + (hewan.pemilik ? hewan.pemilik.length : 0), 0);
            
            const stats = [
                [`Total Panitia: ${data.panitia.length} orang`, `Total Hewan: ${data.hewan.length} ekor`],
                [`Total Sapi: ${totalSapi} ekor`, `Total Kambing: ${totalKambing} ekor`],
                [`Total Pequrban: ${totalPequrban} orang`, `Total Mustahik: ${data.mustahik.length} mustahik`],
                [`Total Guru & Sepuh: ${data.guru.length} orang`, '']
            ];
            
            stats.forEach(([left, right]) => {
                doc.text(left, margin + 5, currentY);
                if (right) doc.text(right, pageWidth/2 + 5, currentY);
                currentY += 5;
            });
            
            currentY += 10;
            
            // Generate tables based on filter or show all
            if (!data.jenisFilter || data.jenisFilter === 'hewan' || data.jenisFilter === 'sapi' || data.jenisFilter === 'kambing') {
                await addHewanTable();
            }
            
            if (!data.jenisFilter || data.jenisFilter === 'panitia') {
                await addPanitiaTable();
            }
            
            if (!data.jenisFilter || data.jenisFilter === 'mustahik') {
                await addMustahikTable();
            }
            
            if (!data.jenisFilter || data.jenisFilter === 'pequrban') {
                await addPequrbanTable();
            }
            
            if (!data.jenisFilter || data.jenisFilter === 'guru') {
                await addGuruTable();
            }
            
            // Add footer to all pages
            const totalPages = doc.internal.getNumberOfPages();
            for (let i = 1; i <= totalPages; i++) {
                doc.setPage(i);
                addFooter();
            }
            
            // Table generation functions
            async function addHewanTable() {
                checkPageBreak(30);
                
                // Table title
                doc.setFillColor(...primaryColor);
                doc.rect(margin, currentY, contentWidth, 8, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.text('DATA HEWAN QURBAN', margin + 5, currentY + 5.5);
                
                currentY += 15;
                
                if (data.hewan.length === 0) {
                    doc.setTextColor(...textColor);
                    doc.setFont('helvetica', 'italic');
                    doc.text('Tidak ada data hewan qurban', margin + 5, currentY);
                    currentY += 15;
                    return;
                }
                
                const hewanTableData = data.hewan.map((hewan, index) => [
                    (index + 1).toString(),
                    hewan.jenis.toUpperCase(),
                    hewan.jenis === 'sapi' ? (hewan.sapiType || hewan.namaSapi || '-') : '-',
                    hewan.pemilik ? hewan.pemilik.length.toString() + ' orang' : '0 orang',
                    hewan.tahun
                ]);
                
                doc.autoTable({
                    startY: currentY,
                    head: [['No', 'Jenis', 'Nama Sapi', 'Jumlah Pemilik', 'Tahun']],
                    body: hewanTableData,
                    theme: 'grid',
                    headStyles: { 
                        fillColor: primaryColor, 
                        textColor: [255, 255, 255],
                        fontSize: 9,
                        fontStyle: 'bold'
                    },
                    bodyStyles: { 
                        fontSize: 8,
                        textColor: textColor
                    },
                    alternateRowStyles: { fillColor: lightGray },
                    margin: { left: margin, right: margin },
                    columnStyles: {
                        0: { cellWidth: 15, halign: 'center' },
                        1: { cellWidth: 25, halign: 'center' },
                        2: { cellWidth: 40 },
                        3: { cellWidth: 30, halign: 'center' },
                        4: { cellWidth: 20, halign: 'center' }
                    }
                });
                
                currentY = doc.lastAutoTable.finalY + 15;
            }
            
            async function addPanitiaTable() {
                checkPageBreak(30);
                
                doc.setFillColor(...primaryColor);
                doc.rect(margin, currentY, contentWidth, 8, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.text('SUSUNAN PANITIA', margin + 5, currentY + 5.5);
                
                currentY += 15;
                
                if (data.panitia.length === 0) {
                    doc.setTextColor(...textColor);
                    doc.setFont('helvetica', 'italic');
                    doc.text('Tidak ada data panitia', margin + 5, currentY);
                    currentY += 15;
                    return;
                }
                
                const panitiaTableData = data.panitia.map((panitia, index) => [
                    (index + 1).toString(),
                    panitia.nama,
                    panitia.jabatan,
                    panitia.hp,
                    panitia.tahun
                ]);
                
                doc.autoTable({
                    startY: currentY,
                    head: [['No', 'Nama', 'Jabatan', 'No. HP', 'Tahun']],
                    body: panitiaTableData,
                    theme: 'grid',
                    headStyles: { 
                        fillColor: primaryColor, 
                        textColor: [255, 255, 255],
                        fontSize: 9,
                        fontStyle: 'bold'
                    },
                    bodyStyles: { 
                        fontSize: 8,
                        textColor: textColor
                    },
                    alternateRowStyles: { fillColor: lightGray },
                    margin: { left: margin, right: margin },
                    columnStyles: {
                        0: { cellWidth: 15, halign: 'center' },
                        1: { cellWidth: 45 },
                        2: { cellWidth: 45 },
                        3: { cellWidth: 35 },
                        4: { cellWidth: 20, halign: 'center' }
                    }
                });
                
                currentY = doc.lastAutoTable.finalY + 15;
            }
            
            async function addMustahikTable() {
                checkPageBreak(30);
                
                doc.setFillColor(...primaryColor);
                doc.rect(margin, currentY, contentWidth, 8, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.text('DISTRIBUSI MUSTAHIK PER RT', margin + 5, currentY + 5.5);
                
                currentY += 15;
                
                if (data.mustahik.length === 0) {
                    doc.setTextColor(...textColor);
                    doc.setFont('helvetica', 'italic');
                    doc.text('Tidak ada data mustahik', margin + 5, currentY);
                    currentY += 15;
                    return;
                }
                
                // Group by RT
                const rtStats = {};
                data.mustahik.forEach(m => {
                    rtStats[m.rt] = (rtStats[m.rt] || 0) + 1;
                });
                
                const totalMustahik = data.mustahik.length;
                const mustahikTableData = Object.entries(rtStats).sort().map(([rt, count]) => [
                    rt,
                    count.toString() + ' mustahik',
                    ((count / totalMustahik) * 100).toFixed(1) + '%'
                ]);
                
                doc.autoTable({
                    startY: currentY,
                    head: [['RT', 'Jumlah mustahik', 'Persentase']],
                    body: mustahikTableData,
                    theme: 'grid',
                    headStyles: { 
                        fillColor: primaryColor, 
                        textColor: [255, 255, 255],
                        fontSize: 9,
                        fontStyle: 'bold'
                    },
                    bodyStyles: { 
                        fontSize: 8,
                        textColor: textColor
                    },
                    alternateRowStyles: { fillColor: lightGray },
                    margin: { left: margin, right: margin },
                    columnStyles: {
                        0: { cellWidth: 40, halign: 'center' },
                        1: { cellWidth: 50, halign: 'center' },
                        2: { cellWidth: 40, halign: 'center' }
                    }
                });
                
                currentY = doc.lastAutoTable.finalY + 15;
            }
            
            async function addPequrbanTable() {
                checkPageBreak(30);
                
                doc.setFillColor(...primaryColor);
                doc.rect(margin, currentY, contentWidth, 8, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.text('DAFTAR LENGKAP PEQURBAN (PEMILIK HEWAN)', margin + 5, currentY + 5.5);
                
                currentY += 15;
                
                // Create comprehensive list of all pequrban
                const allPequrban = [];
                data.hewan.forEach(hewan => {
                    if (hewan.pemilik && hewan.pemilik.length > 0) {
                        hewan.pemilik.forEach(pemilik => {
                            const sapiName = hewan.jenis === 'sapi' ? (hewan.sapiType || hewan.namaSapi || '-') : '-';
                            allPequrban.push({
                                nama: pemilik,
                                jenis: hewan.jenis.toUpperCase(),
                                sapiName: sapiName,
                                tahun: hewan.tahun
                            });
                        });
                    }
                });
                
                if (allPequrban.length === 0) {
                    doc.setTextColor(...textColor);
                    doc.setFont('helvetica', 'italic');
                    doc.text('Tidak ada data pequrban', margin + 5, currentY);
                    currentY += 15;
                    return;
                }
                
                // Sort pequrban
                allPequrban.sort((a, b) => {
                    if (a.tahun !== b.tahun) return b.tahun.localeCompare(a.tahun);
                    if (a.jenis !== b.jenis) return a.jenis.localeCompare(b.jenis);
                    return a.nama.localeCompare(b.nama);
                });
                
                const pequrbanTableData = allPequrban.map((pequrban, index) => [
                    (index + 1).toString(),
                    pequrban.nama,
                    pequrban.jenis,
                    pequrban.sapiName,
                    pequrban.tahun
                ]);
                
                doc.autoTable({
                    startY: currentY,
                    head: [['No', 'Nama Pequrban', 'Jenis Hewan', 'Nama Sapi', 'Tahun']],
                    body: pequrbanTableData,
                    theme: 'grid',
                    headStyles: { 
                        fillColor: primaryColor, 
                        textColor: [255, 255, 255],
                        fontSize: 9,
                        fontStyle: 'bold'
                    },
                    bodyStyles: { 
                        fontSize: 8,
                        textColor: textColor
                    },
                    alternateRowStyles: { fillColor: lightGray },
                    margin: { left: margin, right: margin },
                    columnStyles: {
                        0: { cellWidth: 15, halign: 'center' },
                        1: { cellWidth: 50 },
                        2: { cellWidth: 25, halign: 'center' },
                        3: { cellWidth: 35 },
                        4: { cellWidth: 20, halign: 'center' }
                    }
                });
                
                currentY = doc.lastAutoTable.finalY + 15;
            }
            
            async function addGuruTable() {
                checkPageBreak(30);
                
                doc.setFillColor(...primaryColor);
                doc.rect(margin, currentY, contentWidth, 8, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.text('DATA GURU & SEPUH', margin + 5, currentY + 5.5);
                
                currentY += 15;
                
                if (data.guru.length === 0) {
                    doc.setTextColor(...textColor);
                    doc.setFont('helvetica', 'italic');
                    doc.text('Tidak ada data guru & sepuh', margin + 5, currentY);
                    currentY += 15;
                    return;
                }
                
                const guruTableData = data.guru.map((guru, index) => [
                    (index + 1).toString(),
                    guru.nama,
                    guru.kategori.toUpperCase(),
                    guru.tahun
                ]);
                
                doc.autoTable({
                    startY: currentY,
                    head: [['No', 'Nama', 'Kategori', 'Tahun']],
                    body: guruTableData,
                    theme: 'grid',
                    headStyles: { 
                        fillColor: primaryColor, 
                        textColor: [255, 255, 255],
                        fontSize: 9,
                        fontStyle: 'bold'
                    },
                    bodyStyles: { 
                        fontSize: 8,
                        textColor: textColor
                    },
                    alternateRowStyles: { fillColor: lightGray },
                    margin: { left: margin, right: margin },
                    columnStyles: {
                        0: { cellWidth: 15, halign: 'center' },
                        1: { cellWidth: 70 },
                        2: { cellWidth: 40, halign: 'center' },
                        3: { cellWidth: 25, halign: 'center' }
                    }
                });
                
                currentY = doc.lastAutoTable.finalY + 15;
            }
            
            // Generate filename
            let filename = 'Laporan-Qurban-MNF';
            if (data.yearFilter) filename += `-${data.yearFilter}`;
            if (data.jenisFilter) filename += `-${data.jenisFilter}`;
            filename += `-${new Date().toISOString().split('T')[0]}.pdf`;
            
            // Save PDF
            doc.save(filename);
            
            alert('Laporan PDF berhasil diunduh!');
        }

        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (show) {
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
            }
        }

        function clearForm(modalId) {
            const modal = document.getElementById(modalId);
            const form = modal.querySelector('form');
            form.reset();
            
            // Reset modal titles to "Add" mode
            if (modalId === 'panitiaModal') {
                document.getElementById('panitiaModalTitle').textContent = 'Tambah Panitia';
            } else if (modalId === 'hewanModal') {
                document.getElementById('hewanModalTitle').textContent = 'Tambah Hewan Qurban';
                const container = document.getElementById('pemilikList');
                while (container.children.length > 1) {
                    container.removeChild(container.lastChild);
                }
                document.getElementById('sapiTypeContainer').classList.add('hidden');
                document.getElementById('sapiType').required = false;
            } else if (modalId === 'mustahikModal') {
                document.getElementById('mustahikModalTitle').textContent = 'Tambah Mustahik';
            } else if (modalId === 'guruModal') {
                document.getElementById('guruModalTitle').textContent = 'Tambah Guru/Sepuh';
            }
            
            // Reset edit mode when clearing form
            editMode = { isEditing: false, type: null, id: null };
        }

        // Delete functions
        async function deletePanitia(id) {
            if (confirm('Yakin ingin menghapus data panitia ini?')) {
                if (isDemo) {
                    demoData.panitia = demoData.panitia.filter(p => p.id !== id);
                    loadPanitiaData();
                    loadDashboardData();
                    alert('Data panitia berhasil dihapus!');
                } else {
                    try {
                        showLoading(true);
                        await db.collection('panitia').doc(id).delete();
                        loadPanitiaData();
                        loadDashboardData();
                        showLoading(false);
                        alert('Data panitia berhasil dihapus!');
                    } catch (error) {
                        console.error('Error deleting panitia:', error);
                        alert('Gagal menghapus data panitia: ' + error.message);
                        showLoading(false);
                    }
                }
            }
        }

        async function deleteHewan(id) {
            if (confirm('Yakin ingin menghapus data hewan ini?')) {
                if (isDemo) {
                    demoData.hewan = demoData.hewan.filter(h => h.id !== id);
                    loadHewanData();
                    loadDashboardData();
                    alert('Data hewan berhasil dihapus!');
                } else {
                    try {
                        showLoading(true);
                        await db.collection('hewan').doc(id).delete();
                        loadHewanData();
                        loadDashboardData();
                        showLoading(false);
                        alert('Data hewan berhasil dihapus!');
                    } catch (error) {
                        console.error('Error deleting hewan:', error);
                        alert('Gagal menghapus data hewan: ' + error.message);
                        showLoading(false);
                    }
                }
            }
        }

        async function deleteMustahik(id) {
            if (confirm('Yakin ingin menghapus data mustahik ini?')) {
                if (isDemo) {
                    demoData.mustahik = demoData.mustahik.filter(m => m.id !== id);
                    loadMustahikData();
                    loadDashboardData();
                    alert('Data mustahik berhasil dihapus!');
                } else {
                    try {
                        showLoading(true);
                        await db.collection('mustahik').doc(id).delete();
                        loadMustahikData();
                        loadDashboardData();
                        showLoading(false);
                        alert('Data mustahik berhasil dihapus!');
                    } catch (error) {
                        console.error('Error deleting mustahik:', error);
                        alert('Gagal menghapus data mustahik: ' + error.message);
                        showLoading(false);
                    }
                }
            }
        }

        async function deleteGuru(id) {
            if (confirm('Yakin ingin menghapus data ini?')) {
                if (isDemo) {
                    demoData.guru = demoData.guru.filter(g => g.id !== id);
                    loadGuruData();
                    loadDashboardData();
                    alert('Data guru/sepuh berhasil dihapus!');
                } else {
                    try {
                        showLoading(true);
                        await db.collection('guru').doc(id).delete();
                        loadGuruData();
                        loadDashboardData();
                        showLoading(false);
                        alert('Data guru/sepuh berhasil dihapus!');
                    } catch (error) {
                        console.error('Error deleting guru:', error);
                        alert('Gagal menghapus data guru/sepuh: ' + error.message);
                        showLoading(false);
                    }
                }
            }
        }

        // Photo deletion removed - users can upload but not delete photos

        // Global variable to track edit mode
        let editMode = {
            isEditing: false,
            type: null,
            id: null
        };

        // Edit functions with full Firebase support
        async function editPanitia(id) {
            editMode = { isEditing: true, type: 'panitia', id: id };
            
            if (isDemo) {
                const panitia = demoData.panitia.find(p => p.id === id);
                if (panitia) {
                    fillPanitiaForm(panitia);
                    document.getElementById('panitiaModalTitle').textContent = 'Edit Panitia';
                    openModal('panitiaModal');
                }
            } else {
                try {
                    showLoading(true);
                    const doc = await db.collection('panitia').doc(id).get();
                    if (doc.exists) {
                        const panitia = { id: doc.id, ...doc.data() };
                        fillPanitiaForm(panitia);
                        document.getElementById('panitiaModalTitle').textContent = 'Edit Panitia';
                        openModal('panitiaModal');
                    } else {
                        alert('Data panitia tidak ditemukan!');
                    }
                    showLoading(false);
                } catch (error) {
                    console.error('Error loading panitia for edit:', error);
                    alert('Gagal memuat data panitia: ' + error.message);
                    showLoading(false);
                }
            }
        }

        async function editHewan(id) {
            editMode = { isEditing: true, type: 'hewan', id: id };
            
            if (isDemo) {
                const hewan = demoData.hewan.find(h => h.id === id);
                if (hewan) {
                    fillHewanForm(hewan);
                    document.getElementById('hewanModalTitle').textContent = 'Edit Hewan Qurban';
                    openModal('hewanModal');
                }
            } else {
                try {
                    showLoading(true);
                    const doc = await db.collection('hewan').doc(id).get();
                    if (doc.exists) {
                        const hewan = { id: doc.id, ...doc.data() };
                        fillHewanForm(hewan);
                        document.getElementById('hewanModalTitle').textContent = 'Edit Hewan Qurban';
                        openModal('hewanModal');
                    } else {
                        alert('Data hewan tidak ditemukan!');
                    }
                    showLoading(false);
                } catch (error) {
                    console.error('Error loading hewan for edit:', error);
                    alert('Gagal memuat data hewan: ' + error.message);
                    showLoading(false);
                }
            }
        }

        async function editMustahik(id) {
            editMode = { isEditing: true, type: 'mustahik', id: id };
            
            if (isDemo) {
                const mustahik = demoData.mustahik.find(m => m.id === id);
                if (mustahik) {
                    fillMustahikForm(mustahik);
                    document.getElementById('mustahikModalTitle').textContent = 'Edit Mustahik';
                    openModal('mustahikModal');
                }
            } else {
                try {
                    showLoading(true);
                    const doc = await db.collection('mustahik').doc(id).get();
                    if (doc.exists) {
                        const mustahik = { id: doc.id, ...doc.data() };
                        fillMustahikForm(mustahik);
                        document.getElementById('mustahikModalTitle').textContent = 'Edit Mustahik';
                        openModal('mustahikModal');
                    } else {
                        alert('Data mustahik tidak ditemukan!');
                    }
                    showLoading(false);
                } catch (error) {
                    console.error('Error loading mustahik for edit:', error);
                    alert('Gagal memuat data mustahik: ' + error.message);
                    showLoading(false);
                }
            }
        }

        async function editGuru(id) {
            editMode = { isEditing: true, type: 'guru', id: id };
            
            if (isDemo) {
                const guru = demoData.guru.find(g => g.id === id);
                if (guru) {
                    fillGuruForm(guru);
                    document.getElementById('guruModalTitle').textContent = 'Edit Guru/Sepuh';
                    openModal('guruModal');
                }
            } else {
                try {
                    showLoading(true);
                    const doc = await db.collection('guru').doc(id).get();
                    if (doc.exists) {
                        const guru = { id: doc.id, ...doc.data() };
                        fillGuruForm(guru);
                        document.getElementById('guruModalTitle').textContent = 'Edit Guru/Sepuh';
                        openModal('guruModal');
                    } else {
                        alert('Data guru/sepuh tidak ditemukan!');
                    }
                    showLoading(false);
                } catch (error) {
                    console.error('Error loading guru for edit:', error);
                    alert('Gagal memuat data guru/sepuh: ' + error.message);
                    showLoading(false);
                }
            }
        }

        // Form filling functions
        function fillPanitiaForm(panitia) {
            document.getElementById('panitiaNama').value = panitia.nama;
            document.getElementById('panitiaJabatan').value = panitia.jabatan;
            document.getElementById('panitiaHP').value = panitia.hp;
            document.getElementById('panitiaTahun').value = panitia.tahun;
        }

        function fillHewanForm(hewan) {
            document.getElementById('hewanJenis').value = hewan.jenis;
            document.getElementById('hewanTahun').value = hewan.tahun;
            
            // Update fields based on jenis
            updatePemilikFields();
            updateSapiOptions();
            
            // Set sapi type if applicable
            if (hewan.sapiType) {
                document.getElementById('sapiType').value = hewan.sapiType;
            }
            
            // Fill pemilik fields
            const container = document.getElementById('pemilikList');
            const existingInputs = container.querySelectorAll('.pemilik-input');
            
            // Add more inputs if needed
            while (existingInputs.length < hewan.pemilik.length) {
                addPemilikField();
            }
            
            // Fill all pemilik inputs
            const allInputs = container.querySelectorAll('.pemilik-input');
            hewan.pemilik.forEach((nama, index) => {
                if (allInputs[index]) {
                    allInputs[index].value = nama;
                }
            });
        }

        function fillMustahikForm(mustahik) {
            document.getElementById('mustahikNama').value = mustahik.nama;
            document.getElementById('mustahikRT').value = mustahik.rt;
            document.getElementById('mustahikTahun').value = mustahik.tahun;
        }

        function fillGuruForm(guru) {
            document.getElementById('guruNama').value = guru.nama;
            document.getElementById('guruKategori').value = guru.kategori;
            document.getElementById('guruTahun').value = guru.tahun;
        }

        function resetPanitiaFilters() {
            document.getElementById('filterPanitiaTahun').value = '';
            document.getElementById('searchPanitia').value = '';
            loadPanitiaData();
        }

        function resetHewanFilters() {
            document.getElementById('filterHewanTahun').value = '';
            document.getElementById('filterHewanJenis').value = '';
            document.getElementById('searchHewan').value = '';
            loadHewanData();
        }

        function resetMustahikFilters() {
            document.getElementById('filterMustahikTahun').value = '';
            document.getElementById('filterMustahikRT').value = '';
            document.getElementById('searchMustahik').value = '';
            loadMustahikData();
        }

        function resetGuruFilters() {
            document.getElementById('filterGuruTahun').value = '';
            document.getElementById('filterGuruKategori').value = '';
            document.getElementById('searchGuru').value = '';
            loadGuruData();
        }

        function resetGaleriFilters() {
            document.getElementById('filterGaleriTahun').value = '';
            document.getElementById('searchGaleri').value = '';
            loadGaleriData();
        }

        function viewPhoto(foto) {
            const modal = document.getElementById('photoViewModal');
            const image = document.getElementById('photoViewImage');
            const title = document.getElementById('photoViewTitle');
            const description = document.getElementById('photoViewDescription');
            const category = document.getElementById('photoViewCategory');
            const year = document.getElementById('photoViewYear');
            
            image.src = foto.url;
            image.alt = foto.keterangan;
            title.textContent = foto.keterangan;
            description.textContent = `Kategori: ${foto.kategori.charAt(0).toUpperCase() + foto.kategori.slice(1)}`;
            category.textContent = `📸 ${foto.kategori}`;
            year.textContent = `📅 ${foto.tahun}`;
            
            modal.classList.remove('hidden');
        }



        // Backup & Restore Functions
        async function loadBackupData() {
            // Load backup history for admin users
            if (currentUser) {
                loadBackupHistory();
            }
        }

        async function createBackup() {
            const selectedData = {
                panitia: document.getElementById('backupPanitia').checked,
                hewan: document.getElementById('backupHewan').checked,
                mustahik: document.getElementById('backupMustahik').checked,
                guru: document.getElementById('backupGuru').checked,
                galeri: document.getElementById('backupGaleri').checked
            };

            const yearFilter = document.getElementById('backupTahun').value;
            const format = document.getElementById('backupFormat').value;

            // Check if at least one data type is selected
            if (!Object.values(selectedData).some(selected => selected)) {
                alert('Pilih minimal satu jenis data untuk di-backup!');
                return;
            }

            try {
                showLoading(true);
                
                const backupData = {
                    metadata: {
                        version: '1.0',
                        created: new Date().toISOString(),
                        createdBy: currentUser ? currentUser.email : 'demo',
                        yearFilter: yearFilter || 'all',
                        format: format,
                        dataTypes: Object.keys(selectedData).filter(key => selectedData[key])
                    },
                    data: {}
                };

                // Collect selected data
                if (selectedData.panitia) {
                    let data = isDemo ? demoData.panitia : await getCollectionData('panitia', yearFilter);
                    backupData.data.panitia = data;
                }

                if (selectedData.hewan) {
                    let data = isDemo ? demoData.hewan : await getCollectionData('hewan', yearFilter);
                    backupData.data.hewan = data;
                }

                if (selectedData.mustahik) {
                    let data = isDemo ? demoData.mustahik : await getCollectionData('mustahik', yearFilter);
                    backupData.data.mustahik = data;
                }

                if (selectedData.guru) {
                    let data = isDemo ? demoData.guru : await getCollectionData('guru', yearFilter);
                    backupData.data.guru = data;
                }

                if (selectedData.galeri) {
                    let data = isDemo ? demoData.galeri : await getCollectionData('galeri', yearFilter);
                    backupData.data.galeri = data;
                }

                // Calculate total records
                const totalRecords = Object.values(backupData.data).reduce((total, collection) => total + collection.length, 0);
                backupData.metadata.totalRecords = totalRecords;

                // Create and download backup file
                let filename = `backup-qurban-mnf-${new Date().toISOString().split('T')[0]}`;
                if (yearFilter) filename += `-${yearFilter}`;
                
                if (format === 'json') {
                    const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
                    downloadFile(blob, `${filename}.json`);
                } else if (format === 'csv') {
                    const csvData = convertToCSV(backupData.data);
                    const blob = new Blob([csvData], { type: 'text/csv' });
                    downloadFile(blob, `${filename}.csv`);
                }

                // Save backup history (admin only)
                if (currentUser) {
                    await saveBackupHistory({
                        ...backupData.metadata,
                        filename: `${filename}.${format}`,
                        size: calculateSize(backupData)
                    });
                    loadBackupHistory();
                }

                showLoading(false);
                alert(`Backup berhasil dibuat!\nTotal: ${totalRecords} record\nFormat: ${format.toUpperCase()}`);

            } catch (error) {
                console.error('Error creating backup:', error);
                alert('Gagal membuat backup: ' + error.message);
                showLoading(false);
            }
        }

        async function restoreData() {
            const fileInput = document.getElementById('restoreFile');
            const mode = document.getElementById('restoreMode').value;
            const validate = document.getElementById('validateRestore').checked;

            if (!fileInput.files.length) {
                alert('Pilih file backup terlebih dahulu!');
                return;
            }

            const file = fileInput.files[0];
            const fileExtension = file.name.split('.').pop().toLowerCase();

            if (!['json', 'csv'].includes(fileExtension)) {
                alert('Format file tidak didukung! Gunakan file JSON atau CSV.');
                return;
            }

            // Confirm restore action
            const confirmMessage = mode === 'replace' 
                ? 'PERINGATAN: Ini akan mengganti SEMUA data existing. Yakin ingin melanjutkan?' 
                : 'Data akan digabung dengan data existing. Lanjutkan?';
            
            if (!confirm(confirmMessage)) {
                return;
            }

            try {
                showLoading(true);
                
                const fileContent = await readFile(file);
                let restoreData;

                if (fileExtension === 'json') {
                    restoreData = JSON.parse(fileContent);
                } else {
                    restoreData = parseCSV(fileContent);
                }

                // Validate backup file structure
                if (validate && !validateBackupFile(restoreData)) {
                    showLoading(false);
                    alert('File backup tidak valid atau rusak!');
                    return;
                }

                // Process restore based on mode
                if (mode === 'replace' && currentUser) {
                    await replaceAllData(restoreData);
                } else {
                    await mergeData(restoreData);
                }

                // Refresh all data
                loadDashboardData();
                loadPanitiaData();
                loadHewanData();
                loadMustahikData();
                loadGuruData();
                loadGaleriData();

                showLoading(false);
                
                const totalRestored = calculateRestoredRecords(restoreData);
                alert(`Restore berhasil!\nTotal data yang dipulihkan: ${totalRestored} record`);

                // Clear file input
                fileInput.value = '';

            } catch (error) {
                console.error('Error restoring data:', error);
                alert('Gagal melakukan restore: ' + error.message);
                showLoading(false);
            }
        }

        // Helper functions for backup/restore
        async function getCollectionData(collection, yearFilter) {
            let query = db.collection(collection);
            if (yearFilter) {
                query = query.where('tahun', '==', yearFilter);
            }
            const snapshot = await query.get();
            return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }

        function convertToCSV(data) {
            let csv = '';
            
            Object.keys(data).forEach(collection => {
                csv += `\n=== ${collection.toUpperCase()} ===\n`;
                
                if (data[collection].length > 0) {
                    const headers = Object.keys(data[collection][0]);
                    csv += headers.join(',') + '\n';
                    
                    data[collection].forEach(item => {
                        const row = headers.map(header => {
                            let value = item[header];
                            if (Array.isArray(value)) {
                                value = value.join('; ');
                            }
                            return `"${value || ''}"`;
                        });
                        csv += row.join(',') + '\n';
                    });
                }
                csv += '\n';
            });
            
            return csv;
        }

        function downloadFile(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        function readFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }

        function validateBackupFile(data) {
            // Check if it's a valid backup file structure
            if (data.metadata && data.data) {
                return true; // JSON backup format
            }
            
            // For CSV, just check if it's a string with data
            if (typeof data === 'string' && data.length > 0) {
                return true;
            }
            
            return false;
        }

        function parseCSV(csvContent) {
            // Simple CSV parser for restore
            // This is a basic implementation - in production, use a proper CSV parser
            const lines = csvContent.split('\n');
            const data = {};
            let currentCollection = null;
            let headers = [];
            
            lines.forEach(line => {
                line = line.trim();
                if (line.startsWith('=== ') && line.endsWith(' ===')) {
                    currentCollection = line.replace(/=== | ===/g, '').toLowerCase();
                    data[currentCollection] = [];
                    headers = [];
                } else if (line && currentCollection && !headers.length) {
                    headers = line.split(',').map(h => h.trim());
                } else if (line && currentCollection && headers.length) {
                    const values = line.split(',').map(v => v.replace(/"/g, '').trim());
                    const item = {};
                    headers.forEach((header, index) => {
                        item[header] = values[index] || '';
                    });
                    data[currentCollection].push(item);
                }
            });
            
            return { data };
        }

        async function replaceAllData(restoreData) {
            if (!currentUser) {
                throw new Error('Hanya admin yang dapat mengganti semua data');
            }

            const dataToRestore = restoreData.data || restoreData;

            if (isDemo) {
                // Replace demo data
                Object.keys(dataToRestore).forEach(collection => {
                    if (demoData[collection]) {
                        demoData[collection] = dataToRestore[collection].map((item, index) => ({
                            ...item,
                            id: item.id || (Date.now() + index).toString()
                        }));
                    }
                });
            } else {
                // Replace Firebase data
                for (const [collection, items] of Object.entries(dataToRestore)) {
                    if (['panitia', 'hewan', 'mustahik', 'guru', 'galeri'].includes(collection)) {
                        // Delete all existing documents
                        const snapshot = await db.collection(collection).get();
                        const batch = db.batch();
                        snapshot.docs.forEach(doc => batch.delete(doc.ref));
                        await batch.commit();

                        // Add new documents
                        for (const item of items) {
                            const { id, ...data } = item;
                            await db.collection(collection).add(data);
                        }
                    }
                }
            }
        }

        async function mergeData(restoreData) {
            const dataToRestore = restoreData.data || restoreData;

            if (isDemo) {
                // Merge with demo data
                Object.keys(dataToRestore).forEach(collection => {
                    if (demoData[collection]) {
                        dataToRestore[collection].forEach(item => {
                            const existingIndex = demoData[collection].findIndex(existing => 
                                existing.id === item.id || 
                                (existing.nama === item.nama && existing.tahun === item.tahun)
                            );
                            
                            if (existingIndex >= 0) {
                                // Update existing
                                demoData[collection][existingIndex] = { 
                                    ...demoData[collection][existingIndex], 
                                    ...item 
                                };
                            } else {
                                // Add new
                                demoData[collection].push({
                                    ...item,
                                    id: item.id || Date.now().toString()
                                });
                            }
                        });
                    }
                });
            } else {
                // Merge with Firebase data
                for (const [collection, items] of Object.entries(dataToRestore)) {
                    if (['panitia', 'hewan', 'mustahik', 'guru', 'galeri'].includes(collection)) {
                        for (const item of items) {
                            const { id, ...data } = item;
                            
                            // Try to find existing document by matching key fields
                            let existingDoc = null;
                            if (data.nama && data.tahun) {
                                const snapshot = await db.collection(collection)
                                    .where('nama', '==', data.nama)
                                    .where('tahun', '==', data.tahun)
                                    .get();
                                
                                if (!snapshot.empty) {
                                    existingDoc = snapshot.docs[0];
                                }
                            }
                            
                            if (existingDoc) {
                                // Update existing
                                await existingDoc.ref.update(data);
                            } else {
                                // Add new
                                await db.collection(collection).add(data);
                            }
                        }
                    }
                }
            }
        }

        function calculateSize(data) {
            const jsonString = JSON.stringify(data);
            const bytes = new Blob([jsonString]).size;
            
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function calculateRestoredRecords(restoreData) {
            const dataToCount = restoreData.data || restoreData;
            return Object.values(dataToCount).reduce((total, collection) => {
                return total + (Array.isArray(collection) ? collection.length : 0);
            }, 0);
        }

        async function saveBackupHistory(historyItem) {
            if (isDemo) {
                // Save to localStorage for demo
                const history = JSON.parse(localStorage.getItem('backupHistory') || '[]');
                history.unshift(historyItem);
                localStorage.setItem('backupHistory', JSON.stringify(history.slice(0, 10))); // Keep last 10
            } else {
                // Save to Firebase
                await db.collection('backupHistory').add(historyItem);
            }
        }

        async function loadBackupHistory() {
            const tbody = document.getElementById('backupHistoryTable');
            tbody.innerHTML = '';

            try {
                let history = [];
                
                if (isDemo) {
                    history = JSON.parse(localStorage.getItem('backupHistory') || '[]');
                } else {
                    const snapshot = await db.collection('backupHistory')
                        .orderBy('created', 'desc')
                        .limit(10)
                        .get();
                    history = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                }

                if (history.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="px-4 py-8 text-center text-gray-500 border border-gray-300">
                                <i class="fas fa-database text-3xl mb-2 block"></i>
                                Belum ada riwayat backup
                            </td>
                        </tr>
                    `;
                    return;
                }

                history.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    
                    const createdDate = new Date(item.created).toLocaleDateString('id-ID', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    const dataTypes = item.dataTypes ? item.dataTypes.join(', ') : 'Semua Data';
                    
                    row.innerHTML = `
                        <td class="px-4 py-3 text-sm border border-gray-300">${createdDate}</td>
                        <td class="px-4 py-3 text-sm border border-gray-300">${dataTypes}</td>
                        <td class="px-4 py-3 text-sm border border-gray-300 text-center">${item.totalRecords || 0}</td>
                        <td class="px-4 py-3 text-sm border border-gray-300 text-center uppercase">${item.format}</td>
                        <td class="px-4 py-3 text-sm border border-gray-300 text-center">${item.size || '-'}</td>
                        <td class="px-4 py-3 text-sm border border-gray-300 text-center">${item.createdBy}</td>
                    `;
                    tbody.appendChild(row);
                });

            } catch (error) {
                console.error('Error loading backup history:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-4 py-8 text-center text-red-500 border border-gray-300">
                            <i class="fas fa-exclamation-triangle text-3xl mb-2 block"></i>
                            Gagal memuat riwayat backup
                        </td>
                    </tr>
                `;
            }
        }

        function generateYearOptions() {
            const currentYear = new Date().getFullYear();
            const currentHijriYear = currentYear - 579; // Approximate Hijri year calculation
            
            const yearSelectors = [
                'yearSelector',
                'filterPanitiaTahun', 
                'filterHewanTahun',
                'filterMustahikTahun',
                'filterGuruTahun',
                'filterGaleriTahun',
                'filterLaporanTahun',
                'panitiaTahun',
                'hewanTahun',
                'mustahikTahun',
                'guruTahun',
                'fotoTahun',
                'backupTahun'
            ];
            
            yearSelectors.forEach(selectorId => {
                const selector = document.getElementById(selectorId);
                if (selector) {
                    // Clear existing options except "periode Tahun" for filters
                    if (selectorId.includes('filter') || selectorId === 'backupTahun') {
                        selector.innerHTML = "";
                    } else {
                        selector.innerHTML = '';
                    }
                    
                    // Add current and previous years
                    for (let i = 0; i < 5; i++) {
                        const year = currentYear - i;
                        const hijriYear = currentHijriYear - i;
                        const option = document.createElement('option');
                        option.value = year.toString();
                        option.textContent = `${hijriYear}H / ${year}`;
                        
                        // Set current year as default for non-filter selectors
                        if (i === 0 && !selectorId.includes('filter') && selectorId !== 'backupTahun') {
                            option.selected = true;
                        }
                        
                        selector.appendChild(option);
                    }
                }
            });
        }

        function refreshAllData() {
            const refreshBtn = document.getElementById('refreshBtn');
            const icon = refreshBtn.querySelector('i');
            
            // Add spinning animation
            icon.classList.add('fa-spin');
            refreshBtn.disabled = true;
            refreshBtn.classList.add('opacity-75');
            
            // Show loading
            showLoading(true);
            
            // Refresh all data
            Promise.all([
                loadDashboardData(),
                loadPanitiaData(),
                loadHewanData(),
                loadMustahikData(),
                loadGuruData(),
                loadGaleriData(),
                loadLaporanData()
            ]).then(() => {
                // Remove spinning animation
                icon.classList.remove('fa-spin');
                refreshBtn.disabled = false;
                refreshBtn.classList.remove('opacity-75');
                showLoading(false);
                
                // Show success message
                const originalText = refreshBtn.querySelector('span').textContent;
                refreshBtn.querySelector('span').textContent = 'Data Diperbarui!';
                refreshBtn.classList.remove('bg-emerald-600', 'hover:bg-emerald-700');
                refreshBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                
                // Reset button after 2 seconds
                setTimeout(() => {
                    refreshBtn.querySelector('span').textContent = originalText;
                    refreshBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                    refreshBtn.classList.add('bg-emerald-600', 'hover:bg-emerald-700');
                }, 2000);
                
            }).catch(error => {
                console.error('Error refreshing data:', error);
                
                // Remove spinning animation
                icon.classList.remove('fa-spin');
                refreshBtn.disabled = false;
                refreshBtn.classList.remove('opacity-75');
                showLoading(false);
                
                // Show error message
                const originalText = refreshBtn.querySelector('span').textContent;
                refreshBtn.querySelector('span').textContent = 'Gagal Refresh!';
                refreshBtn.classList.remove('bg-emerald-600', 'hover:bg-emerald-700');
                refreshBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                
                // Reset button after 3 seconds
                setTimeout(() => {
                    refreshBtn.querySelector('span').textContent = originalText;
                    refreshBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                    refreshBtn.classList.add('bg-emerald-600', 'hover:bg-emerald-700');
                }, 3000);
                
                alert('Gagal memperbarui data. Silakan coba lagi.');
            });
        }
    
  document.addEventListener("DOMContentLoaded", () => {
    const tahunHijriah = 1446; // bisa diubah manual
    const tahunMasehi = new Date().getFullYear();
    document.getElementById("periodeTahun").textContent = `${tahunHijriah}H / ${tahunMasehi}`;
  });
</script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const select = document.getElementById("filterTahun");
    if (!select) return;

    const tahunMasehi = new Date().getFullYear();
    const tahunHijriah = tahunMasehi - 579; // perkiraan konversi hijriah sederhana
    const tahunList = [
      `${tahunHijriah}H / ${tahunMasehi}`,
      `${tahunHijriah - 1}H / ${tahunMasehi - 1}`,
      `${tahunHijriah - 2}H / ${tahunMasehi - 2}`,
    ];

    // Kosongkan dulu select lama
    select.innerHTML = "";

    // Tambahkan opsi tahun terbaru ke dropdown
    tahunList.forEach((tahun) => {
      const option = document.createElement("option");
      option.value = tahun;
      option.textContent = tahun;
      select.appendChild(option);
    });
  });
</script>


<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98aa065da6a8df9f',t:'MTc1OTgwNDczMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
